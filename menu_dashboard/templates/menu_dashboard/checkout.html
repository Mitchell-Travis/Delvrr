<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Delvrr Checkout</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jQuery first -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Mapbox Integration -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    {% load product_extras %}
    {% load static %}
    <!-- map.js after jQuery -->
    <script src="{% static 'menu_dashboard/js/map.js' %}"></script>
    {% csrf_token %}
    <style>
        :root {
            /* Base colors */
            --primary: {{ primary_brand_color }};
            --primary-rgb: {{ primary_brand_color|rgb_values }};
            
            /* Neutral shades - modern grayscale */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Monochromatic theme, less reliance on brand color */
            --accent: rgba(var(--primary-rgb), 0.95);
            --accent-light: rgba(var(--primary-rgb), 0.15);
            --accent-medium: rgba(var(--primary-rgb), 0.25);
            
            /* System colors */
            --background: #ffffff;
            --surface: #ffffff;
            --surface-off: #fafafa;
            --field: #f8f9fa;
            
            /* Text colors */
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --text-tertiary: var(--gray-500);
            --text-on-accent: {% if primary_brand_color|is_light %}var(--gray-900){% else %}white{% endif %};
            
            /* Feedback colors */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            
            /* Elevation */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 8px 12px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 12px 16px rgba(0, 0, 0, 0.1);
            
            /* Border radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            
            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            
            /* Typography */
            --font-xs: 11px;
            --font-sm: 13px;
            --font-md: 14px;
            --font-lg: 16px;
            --font-xl: 18px;
            --font-2xl: 20px;
            
            /* Safe areas */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            
            /* App dimensions */
            --header-height: 56px;
            --footer-height: 76px;
            --brand-toggle: #yourBrandColor;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: var(--font-md);
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--background);
            overflow-x: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* App container */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            height: 100%;
            background: var(--background);
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            position: sticky;
            top: 0;
            padding: calc(var(--safe-top) + var(--space-4)) var(--space-4) var(--space-4);
            background: var(--primary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            height: calc(var(--header-height) + var(--safe-top));
            display: flex;
            align-items: center;
        }

        .header-back {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: var(--font-md);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: var(--space-3);
        }

        .header-back:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .header-title {
            flex: 1;
        }

        .header-title h1 {
            font-size: var(--font-lg);
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .header-subtitle {
            font-size: var(--font-sm);
            color: rgba(255, 255, 255, 0.9);
            margin-top: 1px;
        }

        /* Main content */
        .app-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(var(--footer-height) + var(--space-6));
        }

        /* Delivery options */
        .delivery-section {
            background: none;
            padding: var(--space-4);
        }

        .delivery-card {
            background: #fff;
            border-radius: 28px;
            box-shadow: 0 4px 24px rgba(20, 20, 43, 0.06);
            padding: var(--space-6) var(--space-5) var(--space-5);
            border: none;
            max-width: 540px;
            margin: 0 auto var(--space-6);
        }

        .delivery-selector {
            background: #f3f4f6;
            border-radius: 999px;
            display: flex;
            padding: 6px;
            position: relative;
            margin-bottom: var(--space-5);
            box-shadow: none;
            border: none;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .delivery-option {
            flex: 1;
            padding: 12px 0 12px 0;
            border-radius: 999px;
            font-weight: 600;
            font-size: 1.08em;
            color: #444;
            background: none;
            z-index: 1;
            transition: color 0.2s, background 0.2s, box-shadow 0.2s;
            cursor: pointer;
            box-shadow: none;
            text-align: center;
            border: none;
            outline: none;
        }

        .delivery-option.active {
            color: #fff;
            background: var(--primary);
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            position: relative;
        }

        .delivery-slider { display: none !important; }

        .delivery-restaurant {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .delivery-restaurant i {
            font-size: var(--font-md);
            width: 32px;
            height: 32px;
            background: var(--gray-100);
            color: var(--gray-700);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delivery-restaurant p {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }

        .delivery-details-home {
            display: none;
        }

        .delivery-details-home.active {
            display: block;
        }

        .delivery-details-restaurant.inactive {
            display: none;
        }

        .address-button {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            background: #f6f8fa;
            border: 2px dashed #f7bfa0;
            border-radius: 14px;
            padding: var(--space-3) var(--space-3);
            margin: 0 0 var(--space-3) 0;
            box-shadow: none;
            transition: border-color 0.2s;
        }

        .address-button:hover {
            border-color: #f59e42;
        }

        .address-button .location {
            background: #fff;
            color: #f59e42;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            box-shadow: 0 2px 8px rgba(245, 158, 66, 0.08);
        }

        .address-content {
            flex: 1;
            min-width: 0;
        }

        .address-title {
            font-weight: 600;
            font-size: 0.95em;
            color: #222;
        }

        .address-desc {
            font-size: 0.9em;
            color: #6b7280;
        }

        .chevron {
            color: #bdbdbd;
            font-size: 1em;
        }

        /* Map */
        #map-container {
            height: 0;
            overflow: hidden;
            transition: height 0.2s ease;
            border-radius: var(--radius-md);
            margin-top: var(--space-2);
        }

        #map-container.active {
            height: 140px;
            margin-bottom: var(--space-2);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-md);
        }

        .map-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: 0;
        }

        .map-toggle {
            background: #6c63ff;
            color: #fff;
            border-radius: 999px;
            padding: 6px 16px;
            font-weight: 600;
            font-size: 0.9em;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(108, 99, 255, 0.10);
            transition: background 0.2s;
        }

        .map-toggle:hover {
            background: #554ee0;
        }

        .delivery-time {
            background: #ffe6a7;
            color: #222;
            border-radius: 999px;
            padding: 6px 14px;
            font-weight: 600;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
            box-shadow: 0 2px 8px rgba(255, 230, 167, 0.10);
        }

        .delivery-time i {
            color: #f59e42;
            font-size: 0.9em;
        }

        /* Content sections */
        .content-section {
            padding: var(--space-4);
        }

        .section-title {
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .section-title i {
            font-size: var(--font-sm);
            color: var(--gray-500);
        }

        /* Order items - Reimagined for maximum compactness */
        .order-items {
            margin-bottom: var(--space-4);
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--surface);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            position: relative;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .order-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .item-image {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .item-details {
            flex: 1;
            min-width: 0;
            padding-right: var(--space-8);
        }

        .item-name {
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .item-price {
            font-size: var(--font-xs);
            color: var(--text-secondary);
        }

        .item-controls {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: var(--space-1);
            background: var(--field);
            border-radius: var(--radius-full);
            padding: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-100);
        }

        .qty-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: var(--primary);
            font-size: var(--font-sm);
            cursor: pointer;
            border-radius: var(--radius-full);
            font-weight: 600;
        }

        .qty-btn:active {
            background: var(--accent-light);
            color: var(--primary);
        }

        .qty-display {
            min-width: 20px;
            text-align: center;
            font-size: var(--font-xs);
            font-weight: 600;
        }

        .remove-item {
            position: absolute;
            right: -4px;
            top: -4px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--gray-200);
            color: var(--gray-700);
            border: none;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
        }

        .remove-item:active {
            background: var(--gray-300);
        }

        .empty-cart {
            padding: var(--space-6) var(--space-4);
            text-align: center;
            color: var(--text-tertiary);
        }

        .empty-cart i {
            font-size: 36px;
            margin-bottom: var(--space-3);
            opacity: 0.3;
        }

        .empty-cart p {
            font-size: var(--font-md);
        }

        /* Order summary */
        .summary-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
            overflow: hidden;
            margin-bottom: var(--space-4);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-sm);
        }

        .summary-row:not(:last-child) {
            border-bottom: 1px solid var(--gray-100);
        }

        .summary-row:last-child {
            background: var(--field);
            font-weight: 600;
        }

        .summary-label {
            color: var(--text-secondary);
        }

        .summary-value {
            font-weight: 500;
        }

        .summary-total {
            font-weight: 700;
            color: var(--primary);
        }

        /* Payment methods */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: var(--field);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            background: var(--surface);
            gap: var(--space-3);
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .payment-method:hover {
            background: var(--field);
        }

        .payment-method.selected {
            background: var(--field);
            border-left-color: var(--primary);
        }

        .payment-method.selected .payment-radio {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--accent-light);
        }

        .payment-method.selected .payment-radio:after {
            background: var(--primary);
        }

        .payment-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--field);
            border-radius: var(--radius-sm);
            color: var(--primary);
            flex-shrink: 0;
        }

        .payment-details {
            flex: 1;
            min-width: 0;
        }

        .payment-title {
            font-size: var(--font-sm);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .payment-description {
            font-size: var(--font-xs);
            color: var(--text-secondary);
        }

        .payment-badge {
            font-size: 9px;
            padding: 2px 6px;
            background: var(--accent-light);
            color: var(--accent);
            border-radius: var(--radius-full);
            font-weight: 500;
        }

        /* Verification */
        #orderVerificationBox {
            display: none;
            margin-top: var(--space-4);
        }

        .verification-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
            overflow: hidden;
        }

        .verification-header {
            padding: var(--space-3) var(--space-4);
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: var(--font-sm);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .verification-content {
            padding: var(--space-4);
        }

        .verification-message {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-4);
        }

        .verification-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--field);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
            border-left: 3px solid var(--primary);
        }

        .total-label {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }

        .total-value {
            font-weight: 700;
            color: var(--primary);
        }

        .phone-label {
            font-size: var(--font-sm);
            font-weight: 500;
            margin-bottom: var(--space-2);
        }

        .phone-input {
            width: 100%;
            padding: var(--space-3);
            background: var(--field);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: var(--font-md);
            margin-bottom: var(--space-4);
        }

        .phone-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--accent-light);
        }

        .verify-button {
            width: 100%;
            padding: var(--space-3);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: var(--font-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            box-shadow: 0 2px 4px rgba(var(--primary-rgb), 0.2);
            transition: all 0.2s ease;
        }

        .verify-button:hover {
            background: var(--accent);
            box-shadow: 0 4px 8px rgba(var(--primary-rgb), 0.3);
        }

        .verify-button:active {
            background: var(--accent);
            box-shadow: 0 2px 4px rgba(var(--primary-rgb), 0.2);
        }

        .verify-button:disabled {
            opacity: 0.7;
            background: var(--gray-400);
            box-shadow: none;
        }

        .verification-status {
            text-align: center;
            font-size: var(--font-xs);
            margin-top: var(--space-2);
            min-height: 16px;
        }

        /* Footer */
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            z-index: 100;
            border-top: 1px solid var(--gray-100);
            padding: var(--space-4) var(--space-4) calc(var(--space-4) + var(--safe-bottom));
            height: calc(var(--footer-height) + var(--safe-bottom));
        }

        .checkout-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: var(--space-3) var(--space-4);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: var(--font-md);
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(var(--primary-rgb), 0.2);
            transition: all 0.2s ease;
        }

        .checkout-button:active {
            background: var(--accent);
            box-shadow: 0 2px 4px rgba(var(--primary-rgb), 0.2);
        }

        .checkout-button:disabled {
            opacity: 0.7;
            background: var(--gray-400);
            box-shadow: none;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            width: 90%;
            max-width: 360px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: var(--font-md);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 20px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .modal-body {
            padding: var(--space-4);
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            font-size: var(--font-sm);
            font-weight: 500;
            margin-bottom: var(--space-2);
            display: block;
        }

        .form-input {
            width: 100%;
            padding: var(--space-3);
            background: var(--field);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: var(--font-md);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-actions {
            display: flex;
            gap: var(--space-3);
        }

        .btn-cancel {
            flex: 1;
            padding: var(--space-3);
            background: var(--gray-100);
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: var(--font-sm);
            cursor: pointer;
        }

        .btn-save {
            flex: 1;
            padding: var(--space-3);
            background: var(--accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: var(--font-sm);
            cursor: pointer;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-4);
        }

        .loading-logo {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-full);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.2);
            border: 3px solid white;
        }

        .loading-title {
            font-weight: 700;
            font-size: var(--font-lg);
            color: var(--primary);
        }

        .loading-spinner {
            display: flex;
            gap: var(--space-2);
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: loading 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* --- Responsive --- */
        @media (max-width: 600px) {
            .delivery-card {
                padding: var(--space-4) var(--space-2) var(--space-3);
            }
            .address-button {
                padding: var(--space-3) var(--space-2);
            }
            .delivery-selector {
                padding: 4px;
                max-width: 100%;
            }
            .delivery-option {
                font-size: 1em;
                padding: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <button class="header-back" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-title">
                <h1>Checkout</h1>
                <div class="header-subtitle">Review your order</div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-content">
            <!-- Delivery Options -->
            <section class="delivery-section">
                <div class="delivery-card">
                    <div class="delivery-selector">
                        <div class="delivery-option active" data-delivery-type="restaurant">At Restaurant</div>
                        <div class="delivery-option" data-delivery-type="home">Delivery</div>
                        <div class="delivery-slider"></div>
                    </div>

                    <div class="delivery-details">
                        <div class="delivery-details-restaurant">
                            <div class="delivery-restaurant">
                                <i class="fas fa-utensils"></i>
                                <p>Your order will be served at the restaurant</p>
                            </div>
                        </div>

                        <div class="delivery-details-home">
                            <button class="address-button" id="openAddressModal">
                                <i class="fas fa-map-marker-alt location"></i>
                                <div class="address-content">
                                    <div class="address-title">Delivery Address</div>
                                    <div class="address-desc">Add your delivery location</div>
                                </div>
                                <i class="fas fa-chevron-right chevron"></i>
                            </button>

                            <div id="map-container">
                                <div id="map"></div>
                            </div>

                            <div class="map-actions">
                                <button class="map-toggle" onclick="toggleMap()">
                                    <i class="fas fa-map"></i>
                                    <span>View Map</span>
                                </button>
                                <div class="delivery-time">
                                    <i class="far fa-clock"></i>
                                    <span>~14 mins</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Order Items - Compact design -->
            <section class="content-section">
                <div class="section-title">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Your Order</span>
                </div>

                <div class="order-items" id="orderDetailsList">
                    <!-- This will be populated by JS, showing example structure -->
                    <div class="order-item" data-item-id="1">
                        <img src="{% static 'menu_dashboard/placeholder.jpg' %}" alt="Food" class="item-image">
                        <div class="item-details">
                            <div class="item-name">Spicy Chicken Sandwich</div>
                            <div class="item-price">$9.99</div>
                        </div>
                        <div class="item-controls">
                            <button class="qty-btn decrement-item">-</button>
                            <span class="qty-display">1</span>
                            <button class="qty-btn increment-item">+</button>
                        </div>
                    </div>

                    <div class="order-item" data-item-id="2">
                        <img src="{% static 'menu_dashboard/placeholder.jpg' %}" alt="Food" class="item-image">
                        <div class="item-details">
                            <div class="item-name">French Fries with Cheese Dip</div>
                            <div class="item-price">$4.99</div>
                        </div>
                        <div class="item-controls">
                            <button class="qty-btn decrement-item">-</button>
                            <span class="qty-display">2</span>
                            <button class="qty-btn increment-item">+</button>
                        </div>
                    </div>

                    <!-- Example of empty cart state, will be shown if cart is empty -->
                    <!--
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                    </div>
                    -->
                </div>

                <!-- Order Summary - Compact design -->
                <div class="summary-card">
                    <div class="summary-row">
                        <div class="summary-label">Subtotal</div>
                        <div class="summary-value" id="itemTotal">$19.97</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Service Fee</div>
                        <div class="summary-value">$0.25</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Delivery Fee</div>
                        <div class="summary-value">$0.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Total</div>
                        <div class="summary-value summary-total" id="cartTotal">$20.22</div>
                    </div>
                </div>
            </section>

            <!-- Payment Methods -->
            <section class="content-section">
                <div class="section-title">
                    <i class="fas fa-wallet"></i>
                    <span>Payment Method</span>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="cash">
                        <div class="payment-radio"></div>
                        <div class="payment-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-title">Cash on Delivery</div>
                            <div class="payment-description">Pay when your food arrives</div>
                        </div>
                    </div>
                    
                    <div class="payment-method disabled" data-method="card">
                        <div class="payment-radio"></div>
                        <div class="payment-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-title">Card Payment <span class="payment-badge">Soon</span></div>
                            <div class="payment-description">Pay with your card</div>
                        </div>
                    </div>
                    
                    <div class="payment-method disabled" data-method="orange_money">
                        <div class="payment-radio"></div>
                        <div class="payment-icon">
                            <img src="{% static 'menu_dashboard/orange_money.png' %}" alt="Orange Money" width="18" height="18">
                        </div>
                        <div class="payment-details">
                            <div class="payment-title">Orange Money <span class="payment-badge">Soon</span></div>
                            <div class="payment-description">Mobile payment</div>
                        </div>
                    </div>
                </div>
                
                <!-- Verification Box -->
                <div id="orderVerificationBox">
                    <div class="verification-card">
                        <div class="verification-header">
                            <i class="fas fa-shield-alt"></i>
                            <span>Verify Your Order</span>
                        </div>
                        <div class="verification-content">
                            <div class="verification-message">
                                Confirm your phone number to ensure quick delivery
                            </div>
                            
                            <div class="verification-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value" id="ov-total-amount">$20.22</span>
                            </div>
                            
                            <div class="phone-label">Your Phone Number</div>
                            <input type="tel" class="phone-input" id="ov-phone-input" placeholder="Enter phone number">
                            
                            <button class="verify-button" id="ov-verify-btn">
                                <i class="fas fa-check-circle"></i>
                                Verify
                            </button>
                            
                            <div class="verification-status" id="verificationStatus"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <button 
                id="checkoutButton" 
                class="checkout-button"
                data-restaurant-lat="{{ restaurant.latitude }}"
                data-restaurant-lon="{{ restaurant.longitude }}"
                data-restaurant-name-slug="{{ restaurant.slug }}"
                data-restaurant-hashed-slug="{{ restaurant.hashed_slug }}">
                <i class="fas fa-check-circle"></i>
                Place Order
            </button>
        </footer>
    </div>

    <!-- Address Modal -->
    <div class="modal-overlay" id="addressModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Delivery Address</h2>
                <button class="modal-close" id="closeAddressModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="deliveryAddressForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label" for="modal-full-name">Full Name</label>
                        <input type="text" id="modal-full-name" class="form-input" placeholder="Your full name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="modal-phone-number">Phone Number</label>
                        <input type="tel" id="modal-phone-number" class="form-input" placeholder="Your phone number">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="modal-address">Address</label>
                        <input type="text" id="modal-address" class="form-input" placeholder="Your delivery address">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" id="cancelAddress">Cancel</button>
                        <button type="button" class="btn-save" id="saveAddress">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Verifying Order</h2>
                <button class="modal-close" id="closePaymentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="paymentVerificationProgress" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                    <div style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="text-align: center;">Verifying your order...</p>
                </div>
                
                <div id="paymentVerificationSuccess" style="display: none; text-align: center;">
                    <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success); margin-bottom: 16px;"></i>
                    <p style="font-weight: 500; margin-bottom: 8px;">Order verified successfully!</p>
                    <p style="font-size: var(--font-sm); color: var(--text-secondary);">Our team will call you shortly</p>
                </div>
                
                <div id="paymentVerificationFailed" style="display: none; text-align: center;">
                    <i class="fas fa-times-circle" style="font-size: 48px; color: var(--error); margin-bottom: 16px;"></i>
                    <p style="font-weight: 500; margin-bottom: 8px;">Verification failed</p>
                    <p style="font-size: var(--font-sm); color: var(--text-secondary);">Please check your details and try again</p>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button id="tryAgainPayment" class="btn-cancel" style="display: none;">Try Again</button>
                    <button id="continueToCheckout" class="btn-save" style="display: none;">Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-logo">
                <img src="{% static 'menu_dashboard/delvrr.JPG' %}" alt="Delvrr Logo" width="64" height="64">
            </div>
            <div class="loading-title"></div>
            <div class="loading-spinner">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <script>
        // Function to toggle map visibility
        function toggleMap() {
            const mapContainer = document.getElementById('map-container');
            const mapToggle = document.querySelector('.map-toggle span');
            
            if (!mapContainer) return;
            
            if (mapContainer.classList.contains('active')) {
                mapContainer.classList.remove('active');
                mapToggle.textContent = 'View Map';
            } else {
                mapContainer.classList.add('active');
                mapToggle.textContent = 'Hide Map';
            }
        }

        // Transform our updateOrderDetails function to use the new compact order item UI
        function updateOrderDetailsForCompactUI() {
            const cart = getCart();
            const items = Object.entries(cart);
            const orderDetailsList = document.getElementById('orderDetailsList');
            
            if (!orderDetailsList) return;
            
            if (!items.length) {
                // Show empty cart message
                orderDetailsList.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                    </div>
                `;
                document.getElementById('itemTotal').textContent = '$0.00';
                document.getElementById('cartTotal').textContent = '$0.00';
                return;
            }
            
            let html = '';
            let subtotal = 0;
            
            items.forEach(([id, item]) => {
                const qty = item[0];
                const name = item[1];
                const price = item[2];
                const img = item[3];
                
                const itemPrice = parseFloat(price);
                const total = qty * itemPrice;
                subtotal += total;
                
                html += `
                    <div class="order-item" data-item-id="${id}">
                        <img src="${img}" alt="${name}" class="item-image">
                        <div class="item-details">
                            <div class="item-name">${name}</div>
                            <div class="item-price">$${itemPrice.toFixed(2)}</div>
                        </div>
                        <div class="item-controls">
                            <button class="qty-btn decrement-item">-</button>
                            <span class="qty-display">${qty}</span>
                            <button class="qty-btn increment-item">+</button>
                        </div>
                        <button class="remove-item" onclick="deleteCartItem('${id}')">
                            <i class="fas fa-times" style="font-size: 8px;"></i>
                        </button>
                    </div>
                `;
            });
            
            orderDetailsList.innerHTML = html;
            
            // Update the summary values
            const totalDue = subtotal + 0.25; // Adding service fee
            document.getElementById('itemTotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `$${totalDue.toFixed(2)}`;
            
            // If verification box is visible, update the verification amount
            const verificationAmount = document.getElementById('ov-total-amount');
            if (verificationAmount) {
                verificationAmount.textContent = `$${totalDue.toFixed(2)}`;
            }
        }

        // Main initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI elements
            const deliveryOptions = document.querySelectorAll('.delivery-option');
            const deliverySlider = document.querySelector('.delivery-slider');
            const paymentMethods = document.querySelectorAll('.payment-method:not(.disabled)');
            
            // Address modal elements
            const addressModal = document.getElementById('addressModal');
            const openAddressBtn = document.getElementById('openAddressModal');
            const closeAddressBtn = document.getElementById('closeAddressModal');
            const saveAddressBtn = document.getElementById('saveAddress');
            const cancelAddressBtn = document.getElementById('cancelAddress');
            
            // Verification elements
            const verifyBtn = document.getElementById('ov-verify-btn');
            const verificationModal = document.getElementById('paymentModal');
            const closeVerificationBtn = document.getElementById('closePaymentModal');
            const continueBtn = document.getElementById('continueToCheckout');
            const tryAgainBtn = document.getElementById('tryAgainPayment');
            
            // Checkout button
            const checkoutButton = document.getElementById('checkoutButton');
            
            // Setup delivery type toggle
            deliveryOptions.forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('active')) return;
                    
                    deliveryOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    const isRightOption = this === deliveryOptions[1];
                    deliverySlider.classList.toggle('right', isRightOption);
                    
                    const deliveryType = this.getAttribute('data-delivery-type');
                    const restaurantDetails = document.querySelector('.delivery-details-restaurant');
                    const homeDetails = document.querySelector('.delivery-details-home');
                    const verificationBox = document.getElementById('orderVerificationBox');
                    
                    if (deliveryType === 'home') {
                        restaurantDetails.classList.add('inactive');
                        homeDetails.classList.add('active');
                        verificationBox.style.display = 'block';
                    } else {
                        restaurantDetails.classList.remove('inactive');
                        homeDetails.classList.remove('active');
                        verificationBox.style.display = 'none';
                    }
                    
                    // Update state in map.js if it exists
                    if (typeof state !== 'undefined') {
                        state.deliveryTypeUserOverride = deliveryType;
                        state.deliveryType = deliveryType;
                        updateDeliveryTypeUI();
                    }
                });
            });
            
            // Setup payment method selection
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    paymentMethods.forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // Update state in map.js if it exists
                    if (typeof state !== 'undefined') {
                        state.selectedPaymentMethod = this.getAttribute('data-method');
                        updateCheckoutButtonState();
                    }
                });
            });
            
            // Address modal setup
            if (openAddressBtn && addressModal) {
                openAddressBtn.addEventListener('click', function() {
                    addressModal.classList.add('active');
                });
            }
            
            if (closeAddressBtn) {
                closeAddressBtn.addEventListener('click', function() {
                    addressModal.classList.remove('active');
                });
            }
            
            if (cancelAddressBtn) {
                cancelAddressBtn.addEventListener('click', function() {
                    addressModal.classList.remove('active');
                });
            }
            
            if (saveAddressBtn) {
                saveAddressBtn.addEventListener('click', function() {
                    const fullName = document.getElementById('modal-full-name').value.trim();
                    const phoneNumber = document.getElementById('modal-phone-number').value.trim();
                    const address = document.getElementById('modal-address').value.trim();
                    
                    if (!fullName || !phoneNumber || !address) {
                        alert('Please fill in all fields');
                        return;
                    }
                    
                    // Update state in map.js if it exists
                    if (typeof state !== 'undefined') {
                        state.homeDeliveryAddress = {
                            full_name: fullName,
                            phone_number: phoneNumber,
                            address: address
                        };
                        
                        // Update the address button text
                        const addressDesc = document.querySelector('.address-button .address-desc');
                        if (addressDesc) {
                            addressDesc.textContent = address;
                        }
                        
                        // Update verification phone input if empty
                        const verificationPhone = document.getElementById('ov-phone-input');
                        if (verificationPhone && !verificationPhone.value.trim()) {
                            verificationPhone.value = phoneNumber;
                        }
                        
                        updateCheckoutButtonState();
                    }
                    
                    addressModal.classList.remove('active');
                });
            }
            
            // Verification setup
            if (verifyBtn && verificationModal) {
                verifyBtn.addEventListener('click', function() {
                    const phoneNumber = document.getElementById('ov-phone-input').value.trim();
                    if (!phoneNumber || phoneNumber.length < 8) {
                        document.getElementById('verificationStatus').innerHTML = 
                            '<span style="color: var(--error);"><i class="fas fa-exclamation-circle"></i> Please enter a valid phone number</span>';
                        return;
                    }
                    
                    verificationModal.classList.add('active');
                    document.getElementById('paymentVerificationProgress').style.display = 'flex';
                    document.getElementById('paymentVerificationSuccess').style.display = 'none';
                    document.getElementById('paymentVerificationFailed').style.display = 'none';
                    document.getElementById('continueToCheckout').style.display = 'none';
                    document.getElementById('tryAgainPayment').style.display = 'none';
                    
                    // Simulate verification
                    setTimeout(() => {
                        document.getElementById('paymentVerificationProgress').style.display = 'none';
                        document.getElementById('paymentVerificationSuccess').style.display = 'block';
                        document.getElementById('continueToCheckout').style.display = 'block';
                        
                        // Update state in map.js if it exists
                        if (typeof state !== 'undefined') {
                            state.paymentVerified = true;
                            document.getElementById('verificationStatus').innerHTML = 
                                '<span style="color: var(--success);"><i class="fas fa-check-circle"></i> Verification successful</span>';
                            updateCheckoutButtonState();
                        }
                    }, 1500);
                });
            }
            
            if (closeVerificationBtn) {
                closeVerificationBtn.addEventListener('click', function() {
                    verificationModal.classList.remove('active');
                });
            }
            
            if (continueBtn) {
                continueBtn.addEventListener('click', function() {
                    verificationModal.classList.remove('active');
                });
            }
            
            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', function() {
                    verificationModal.classList.remove('active');
                });
            }
            
            // Override the original updateOrderDetails function if it exists
            if (typeof updateOrderDetails === 'function') {
                window.originalUpdateOrderDetails = updateOrderDetails;
                window.updateOrderDetails = updateOrderDetailsForCompactUI;
                
                // Initialize order display
                updateOrderDetailsForCompactUI();
            }
            
            // Connect our new delete item function to the original if it exists
            if (typeof deleteCartItem !== 'function') {
                window.deleteCartItem = function(id) {
                    console.log('Removing item', id);
                    alert('Item removal would be processed here');
                };
            }
            
            // Add event listeners for quantity controls
            document.addEventListener('click', function(e) {
                const target = e.target;
                
                // Increment button
                if (target.classList.contains('increment-item')) {
                    const orderItem = target.closest('.order-item');
                    if (orderItem) {
                        const itemId = orderItem.getAttribute('data-item-id');
                        if (typeof updateCart === 'function') {
                            updateCart(itemId, 1);
                        } else {
                            console.log('Would increment item', itemId);
                        }
                    }
                }
                
                // Decrement button
                if (target.classList.contains('decrement-item')) {
                    const orderItem = target.closest('.order-item');
                    if (orderItem) {
                        const itemId = orderItem.getAttribute('data-item-id');
                        if (typeof updateCart === 'function') {
                            updateCart(itemId, -1);
                        } else {
                            console.log('Would decrement item', itemId);
                        }
                    }
                }
            });
            
            // Add haptic feedback for all buttons
            document.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button') || 
                    e.target.classList.contains('payment-method')) {
                    if ('vibrate' in navigator) {
                        navigator.vibrate(30);
                    }
                }
            }, { passive: true });
            
            // Ensure cart is loaded if the function exists
            if (typeof ensureCartLoaded === 'function') {
                ensureCartLoaded();
            }
        });
    </script>
</body>
</html>