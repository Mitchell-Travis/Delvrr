<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Delvrr Checkout</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Mapbox Integration -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <style>
        :root {
            --primary: #2e7d32;
            --primary-gradient: linear-gradient(135deg, #2e7d32, #1b5e20);
            --surface: #ffffff;
            --surface-alt: #f1f8e9;
            --text: #212121;
            --text-secondary: #757575;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --accent: #03a9f4;
            --input-border: #ced4da;
            --input-focus-border: var(--primary);
            --input-bg: #f8f9fa;
            --modal-bg: rgba(0, 0, 0, 0.5);
            --modal-inner-bg: var(--surface);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--surface-alt);
            color: var(--text);
            line-height: 1.5;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 400px;
            margin: 10px auto;
            min-height: calc(100vh - 20px);
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--surface);
            padding: calc(0.8rem + var(--safe-area-top)) 1rem 0.8rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            padding: 6px;
            border-radius: var(--radius-sm);
        }

        .back-button:active {
            opacity: 0.7;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
        }

        .delivery-options {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .delivery-options-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
            color: var(--text);
        }

        .delivery-switch-container {
            display: flex;
            background-color: #f9f9f9;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .delivery-switch-label {
            padding: 0.8rem 1.2rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            user-select: none;
            text-align: center;
            flex-grow: 1;
        }

        .delivery-switch-label.active {
            background-color: var(--primary);
            color: white;
        }

        .delivery-details {
            padding: 1rem;
        }

        .delivery-details-home {
            display: none;
        }

        .delivery-details-home.active {
            display: block;
        }

        .delivery-details-restaurant {
            display: block;
        }

        .delivery-details-restaurant.inactive {
            display: none;
        }

        .table-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background-color: #f0f7f2;
            padding: 0.8rem;
            border-radius: var(--radius-sm);
        }

        .table-info i {
            color: var(--accent);
            font-size: 1rem;
        }

        .delivery-address-button {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            color: var(--text);
            cursor: pointer;
            padding: 0;
        }

        .delivery-address-button i {
            font-size: 1rem;
            color: var(--accent);
        }

        .delivery-address-button:active {
            opacity: 0.8;
        }

        .address-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .address-modal.active {
            display: flex;
        }

        .address-modal-content {
            background-color: var(--modal-inner-bg);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .address-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .address-modal-header h2 {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text);
            margin: 0;
        }

        .close-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .close-button:active {
            opacity: 0.7;
        }

        .address-form > div {
            margin-bottom: 1rem;
        }

        .address-form label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.2rem;
        }

        .address-form input[type="text"],
        .address-form input[type="tel"] {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid var(--input-border);
            border-radius: var(--radius-sm);
            background-color: var(--input-bg);
            font-size: 0.85rem;
            color: var(--text);
            transition: border-color 0.2s ease;
        }

        .address-form input[type="text"]:focus,
        .address-form input[type="tel"]:focus {
            border-color: var(--input-focus-border);
            outline: none;
        }

        .address-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .address-actions button {
            padding: 0.7rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s ease;
        }

        .address-actions button:active {
            opacity: 0.8;
        }

        .address-actions .save-address {
            background-color: var(--primary);
            color: white;
        }

        .address-actions .cancel-address {
            background-color: var(--surface-alt);
            color: var(--text-secondary);
            border: 1px solid var(--input-border);
        }

        .estimated-delivery {
            font-size: 0.75rem;
            color: #558b2f;
            font-style: italic;
            margin-top: 0.6rem;
        }

        .order-section {
            padding: 1rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
            color: var(--text);
        }

        .order-item {
            background-color: var(--surface);
            border-radius: var(--radius-sm);
            margin-bottom: 0.4rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.05);
            font-size: 0.8rem;
        }

        .order-item img {
            width: 36px;
            height: 36px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            background-color: #eee;
        }

        .item-details {
            flex-grow: 1;
        }

        .item-details h3 {
            font-size: 0.85rem;
            margin-bottom: 0.1rem;
        }

        .item-details p {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0;
        }

        .item-quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: auto;
        }

        .quantity-button {
            background: none;
            border: 1px solid var(--input-border);
            border-radius: var(--radius-sm);
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .quantity-button:active {
            opacity: 0.7;
        }

        .item-quantity {
            font-weight: 500;
            font-size: 0.8rem;
            width: 20px;
            text-align: center;
        }

        .delete-item {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .delete-item:active {
            opacity: 0.7;
        }

        .payment-methods {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
        }

        .payment-methods-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
            color: var(--text);
        }

        .payment-option {
            display: none; /* Hidden by default */
            background-color: var(--surface);
            border-radius: var(--radius-sm);
            padding: 0.7rem;
            margin-bottom: 0.5rem;
            align-items: center;
            gap: 0.8rem;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .payment-option.active {
            display: flex; /* Shown when active */
        }

        .payment-option.selected {
            border-color: var(--primary);
            background-color: rgba(var(--primary-rgb, 46, 125, 50), 0.15);
        }

        .payment-icon {
            background-color: #e8f5e9;
            color: var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .payment-details h3 {
            font-size: 0.85rem;
            margin-bottom: 0.1rem;
        }

        .payment-details p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .checkout-bar {
            background-color: var(--surface);
            padding: 0.7rem 1rem calc(0.7rem + var(--safe-area-bottom));
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -0.5px 1px rgba(0, 0, 0, 0.05);
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .total-amount {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .total-amount p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .total-amount span {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text);
        }

        .checkout-button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.8rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .checkout-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .checkout-button:active:not(:disabled) {
            transform: scale(0.98);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-cart {
            padding: 1.5rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-cart i {
            font-size: 1.5rem;
            margin-bottom: 0.6rem;
        }

        html {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        input,
        textarea,
        select {
            font-size: 16px !important;
            line-height: 1.4;
        }

        .address-modal-content input,
        .address-modal-content textarea {
            font-size: 16px !important;
            line-height: 1.4;
        }
        /* Add these styles to your existing CSS */
 #map-container {
      height: 0;
      overflow: hidden;
      transition: height 0.3s ease;
      margin-top: 10px;
      border-radius: var(--radius-md);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    #map-container.active {
      height: 200px;
      margin-bottom: 15px;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .map-toggle {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 0;
      margin-top: 5px;
      cursor: pointer;
    }
    .distance-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 10px 0;
      padding: 10px;
      background-color: #f0f7f2;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
    }
    .distance-indicator i { color: var(--accent); }
    .distance-status { font-weight: 500; }
    .distance-status.nearby { color: #2e7d32; }
    .distance-status.far    { color: #ff6f00; }
    .mapboxgl-popup {
      max-width: 200px;
    }
    .mapboxgl-popup-content {
      text-align: center;
      padding: 10px;
      font-family: 'Poppins', sans-serif;
    }

    </style>
</head>
<body>
     <div class="app-container">
    <header class="header">
      <button class="back-button" onclick="window.history.back()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1>Checkout</h1>
      <div></div>
    </header>

    <section class="delivery-options">
      <h2 class="delivery-options-title">Delivery</h2>
      <div class="delivery-switch-container">
        <div class="delivery-switch-label active" data-delivery-type="restaurant">
          At Restaurant
        </div>
        <div class="delivery-switch-label" data-delivery-type="home">
          Home
        </div>
      </div>
    </section>

    <div class="delivery-details">
      <div class="delivery-details-restaurant">
        <div class="table-info">
          <i class="fas fa-chair"></i>
          Your food will be delivered to <strong>Table 1</strong>.
        </div>
        <div class="distance-indicator" id="distanceIndicator">
          <i class="fas fa-map-marker-alt"></i>
          <div>
            <span class="distance-value">Detecting your location...</span>
            <div class="distance-status" id="distanceStatus"></div>
          </div>
        </div>
      </div>

      <div class="delivery-details-home">
        <button class="delivery-address-button" id="openAddressModal">
          <i class="fas fa-map-marker-alt"></i>
          Delivery Address
        </button>
        <p class="estimated-delivery">
          <i class="far fa-clock"></i> ~14 mins
        </p>
      </div>

      <!-- ← Always-visible map controls ↓ -->
      <div class="map-wrapper">
        <button class="map-toggle" id="toggleMap">
          <i class="fas fa-map"></i> Show map
        </button>
        <div id="map-container">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <section class="order-section">
      <h2 class="section-title">Your Order</h2>
      <div id="orderDetailsList">
        <div class="empty-cart">
          <i class="fas fa-shopping-bag"></i>
          <p>Your cart is empty.</p>
        </div>
      </div>
    </section>

    <section class="payment-methods">
      <h2 class="payment-methods-title">Payment</h2>
      <div class="payment-option restaurant-only" data-method="Cash on Delivery">
        <div class="payment-icon"><i class="fas fa-money-bill-alt"></i></div>
        <div class="payment-details">
          <h3>Cash on Delivery</h3>
          <p>Pay in cash when your food arrives</p>
        </div>
      </div>
      <div class="payment-option home-only" data-method="Cash on Delivery">
        <div class="payment-icon"><i class="fas fa-money-bill-alt"></i></div>
        <div class="payment-details">
          <h3>Pay Cash to Rider</h3>
          <p>Pay cash upon delivery</p>
        </div>
      </div>
      <div class="payment-option home-only" data-method="Mobile Money">
        <div class="payment-icon"><i class="fas fa-mobile-alt"></i></div>
        <div class="payment-details">
          <h3>Mobile Money</h3>
          <p>Pay via mobile money upon delivery</p>
        </div>
      </div>
    </section>

    <div class="checkout-bar">
      <div class="total-amount">
        <p>Item total</p>
        <span id="itemTotal">$0.00</span>
      </div>
      <div class="total-amount">
        <p>To Pay</p>
        <span id="cartTotal" style="font-size:1.1rem; font-weight:600;">$0.00</span>
      </div>
      <button
        id="checkoutButton"
        class="checkout-button"
        data-restaurant-lat="{{ restaurant_lat }}"
        data-restaurant-lon="{{ restaurant_lon }}"
        disabled
      >
        <i class="fas fa-check-circle"></i> Place Order
      </button>
    </div>

    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <div class="address-modal" id="addressModal">
      <div class="address-modal-content">
        <div class="address-modal-header">
          <h2>Enter Delivery Address</h2>
          <button class="close-button" id="closeAddressModal">×</button>
        </div>
        <form class="address-form" id="deliveryAddressForm">
          <div>
            <label for="full-name">Full Name:</label>
            <input type="text" id="modal-full-name" placeholder="Your Full Name">
          </div>
          <div>
            <label for="phone-number">Phone Number:</label>
            <input type="tel" id="modal-phone-number" placeholder="Your Phone Number">
          </div>
          <div>
            <label for="address">Address:</label>
            <input type="text" id="modal-address" placeholder="Your Street Address">
          </div>
          <div class="address-actions">
            <button type="button" class="cancel-address" id="cancelAddress">Cancel</button>
            <button type="button" class="save-address"   id="saveAddress">Save Address</button>
          </div>
        </form>
      </div>
    </div>
  </div>


    <div id="toast-container" class="toast-container"></div>
     <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
   <script>
$(document).ready(function () {
  // ── Constants & State ──
  const SERVICE_FEE        = 0.51;
  const DELIVERY_FEE       = 0.00;
  const THRESHOLD_DISTANCE = 100; // meters

  let selectedPaymentMethod = 'Cash on Delivery';
  let deliveryType          = 'restaurant';
  let homeDeliveryAddress   = {};
  const tableNumber         = '1';

  // ── Read & round coords ──
  const $checkoutButton = $('#checkoutButton');
  const rawLat          = parseFloat($checkoutButton.attr('data-restaurant-lat'));
  const rawLon          = parseFloat($checkoutButton.attr('data-restaurant-lon'));
  const restaurantLat   = parseFloat(rawLat.toFixed(8));
  const restaurantLon   = parseFloat(rawLon.toFixed(8));

  // ── Elements ──
  const $openAddressModal  = $('#openAddressModal');
  const $addressModal      = $('#addressModal');
  const $closeAddressModal = $('#closeAddressModal');
  const $saveAddress       = $('#saveAddress');
  const $cancelAddress     = $('#cancelAddress');
  const $loadingOverlay    = $('#loading-overlay');

  const $modalFullName     = $('#modal-full-name');
  const $modalPhoneNumber  = $('#modal-phone-number');
  const $modalAddress      = $('#modal-address');

  const mapContainer       = document.getElementById('map-container');
  const toggleMapButton    = document.getElementById('toggleMap');
  const $distanceValue     = $('.distance-value');
  const $distanceStatus    = $('#distanceStatus');

  let map, userMarker, restaurantMarker;
  let isMapInitialized = false;

  // ── Mapbox Setup ──
  mapboxgl.accessToken = 'pk.eyJ1IjoibWl0Y2hlbGwyMzEiLCJhIjoiY205dGF0YXprMGFoajJrc2I5cDVvNnprZSJ9.LiQvQKUCOIe5fW0QYSOSFQ';

  // ── Map Toggle ──
  toggleMapButton.addEventListener('click', () => {
    mapContainer.classList.toggle('active');
    toggleMapButton.innerHTML = mapContainer.classList.contains('active')
      ? '<i class="fas fa-map"></i> Hide map'
      : '<i class="fas fa-map"></i> Show map';
    if (mapContainer.classList.contains('active') && !isMapInitialized) {
      initializeMap();
      isMapInitialized = true;
    }
  });

  // ── Initialize Map & Restaurant Marker ──
  function initializeMap() {
    map = new mapboxgl.Map({
      container: 'map',
      style:     'mapbox://styles/mapbox/streets-v11',
      center:    [restaurantLon, restaurantLat],
      zoom:      14
    });
    map.on('load', () => {
      // restaurant icon
      const restaurantEl = document.createElement('div');
      restaurantEl.innerHTML = '<i class="fas fa-utensils fa-2x"></i>';
      restaurantEl.style.color = '#d32f2f';
      restaurantEl.style.textShadow = '0 0 3px #fff';

      restaurantMarker = new mapboxgl.Marker({ element: restaurantEl })
        .setLngLat([restaurantLon, restaurantLat])
        .setPopup(new mapboxgl.Popup().setHTML('<strong>Restaurant</strong>'))
        .addTo(map);

      getUserLocationForMap();
    });
  }

  // ── Get & Mark User Location ──
  function getUserLocationForMap() {
    if (!navigator.geolocation) {
      $distanceValue.text('Geolocation not supported');
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const userLng = pos.coords.longitude;
      const userLat = pos.coords.latitude;

      const userEl = document.createElement('div');
      userEl.innerHTML = '<i class="fas fa-user fa-2x"></i>';
      userEl.style.color = '#1976d2';
      userEl.style.textShadow = '0 0 3px #fff';

      if (userMarker) userMarker.remove();
      userMarker = new mapboxgl.Marker({ element: userEl })
        .setLngLat([userLng, userLat])
        .setPopup(new mapboxgl.Popup().setHTML('<strong>Your Location</strong>'))
        .addTo(map);

      const bounds = new mapboxgl.LngLatBounds()
        .extend([userLng, userLat])
        .extend([restaurantLon, restaurantLat]);
      map.fitBounds(bounds, { padding: 70 });

      if (map.getLayer('route')) {
        map.removeLayer('route');
        map.removeSource('route');
      }
      map.addSource('route', {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: [
              [userLng, userLat],
              [restaurantLon, restaurantLat]
            ]
          }
        }
      });
      map.addLayer({
        id:     'route',
        type:   'line',
        source: 'route',
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint:  { 'line-color': '#03a9f4', 'line-width': 3, 'line-dasharray': [2,1] }
      });

      updateDistanceDisplay(userLng, userLat, restaurantLon, restaurantLat);
    }, err => {
      console.error('Geo error', err);
      $distanceValue.text('Could not determine your location');
    });
  }

  // ── Update Distance UI ──
  function updateDistanceDisplay(uLng, uLat, rLng, rLat) {
    const dist = turf.distance(turf.point([uLng, uLat]), turf.point([rLng, rLat]), { units: 'meters' });
    $distanceValue.text(dist < 1000
      ? `${Math.round(dist)} meters away`
      : `${(dist/1000).toFixed(1)} km away`
    );
    $distanceStatus
      .text(dist <= THRESHOLD_DISTANCE
        ? "You're at the restaurant!"
        : "Delivery recommended"
      )
      .toggleClass('nearby', dist <= THRESHOLD_DISTANCE)
      .toggleClass('far', dist > THRESHOLD_DISTANCE);
  }

  // ── Geolocation Promise ──
  function getUserLocation() {
    return new Promise((res, rej) => {
      !navigator.geolocation
        ? rej('No geolocation')
        : navigator.geolocation.getCurrentPosition(
            p => res([p.coords.longitude, p.coords.latitude]),
            e => rej(e)
          );
    });
  }

  // ── Straight‐Line Distance ──
  async function calculateDistance(userLoc, restLoc) {
    return turf.distance(turf.point(userLoc), turf.point(restLoc), { units: 'meters' });
  }

  // ── Delivery‐Type Logic + Auto-open on Home ──
  async function setDeliveryType() {
    try {
      const userLoc = await getUserLocation();
      const dist    = await calculateDistance(userLoc, [restaurantLon, restaurantLat]);

      if (dist < THRESHOLD_DISTANCE) {
        deliveryType = 'restaurant';
        $('.delivery-details-restaurant').show();
        $('.delivery-details-home').hide();
      } else {
        deliveryType = 'home';
        $('.delivery-details-home').show();
        $('.delivery-details-restaurant').hide();
        // auto-open map
        if (!mapContainer.classList.contains('active')) {
          mapContainer.classList.add('active');
          toggleMapButton.innerHTML = '<i class="fas fa-map"></i> Hide map';
        }
        if (!isMapInitialized) {
          initializeMap(); isMapInitialized = true;
        } else {
          getUserLocationForMap();
        }
      }
      // update switch labels
      $('.delivery-switch-label').removeClass('active');
      $(`.delivery-switch-label[data-delivery-type="${deliveryType}"]`).addClass('active');
    } catch {
      // fallback to home + auto-open map
      deliveryType = 'home';
      $('.delivery-details-home').show();
      $('.delivery-details-restaurant').hide();
      $('.delivery-switch-label').removeClass('active');
      $('.delivery-switch-label[data-delivery-type="home"]').addClass('active');
      if (!mapContainer.classList.contains('active')) {
        mapContainer.classList.add('active');
        toggleMapButton.innerHTML = '<i class="fas fa-map"></i> Hide map';
      }
      if (!isMapInitialized) {
        initializeMap(); isMapInitialized = true;
      } else {
        getUserLocationForMap();
      }
    }

    updatePaymentOptions();
    updateOrderDetails();
    updateCheckoutButtonState();
  }

  // ── Block Manual Switch & Alert ──
  $('.delivery-switch-label').on('click', function () {
    const wanted = $(this).data('delivery-type');
    if (deliveryType === wanted) return;
    if (wanted === 'restaurant') {
      alert("You’re not at the restaurant!");
    } else {
      alert("You can’t switch away from Home delivery manually.");
    }
  });

  // ── Address Modal ──
  $openAddressModal.on('click',  () => $addressModal.addClass('active'));
  $closeAddressModal.on('click', () => $addressModal.removeClass('active'));
  $cancelAddress    .on('click', () => $addressModal.removeClass('active'));
  $saveAddress      .on('click', () => {
    const full  = $modalFullName.val().trim();
    const phone = $modalPhoneNumber.val().trim();
    const addr  = $modalAddress.val().trim();
    if (!full || !phone || !addr) return alert('Please fill in all fields');
    homeDeliveryAddress = { full_name: full, phone_number: phone, address: addr };
    $addressModal.removeClass('active');
    updateCheckoutButtonState();
  });

  // ── Payment Options ──
  function updatePaymentOptions() {
    if (deliveryType === 'restaurant') {
      $('.payment-option.restaurant-only').addClass('active');
      $('.payment-option.home-only').removeClass('active');
      $('.payment-option[data-method="Cash on Delivery"].restaurant-only').addClass('selected');
      selectedPaymentMethod = 'Cash on Delivery';
    } else {
      $('.payment-option.home-only').addClass('active');
      $('.payment-option.restaurant-only').removeClass('active');
      $('.payment-option').removeClass('selected');
      selectedPaymentMethod = '';
    }
  }
  $('.payment-option').on('click', function () {
    if (!$(this).hasClass('active')) return;
    $('.payment-option').removeClass('selected');
    $(this).addClass('selected');
    selectedPaymentMethod = $(this).data('method');
    updateCheckoutButtonState();
    if ('vibrate' in navigator) navigator.vibrate(50);
  });

  // ── Cart & Order Details ──
  function updateOrderDetails() {
    const cart = JSON.parse(localStorage.getItem('cart') || '{}');
    const $list = $('#orderDetailsList');
    let html = '', subtotal = 0;
    if (!Object.keys(cart).length) {
      $list.html(`
        <div class="empty-cart">
          <i class="fas fa-shopping-bag"></i>
          <p>Your cart is empty.</p>
        </div>
      `);
      $('#itemTotal').text('$0.00');
      $('#cartTotal').text('$0.00');
      return;
    }
    for (const [id, item] of Object.entries(cart)) {
      const [qty, name, price, img] = item;
      const total = qty * parseFloat(price);
      subtotal += total;
      html += `
        <div class="order-item" data-item-id="${id}">
          <img src="${img}" alt="${name}">
          <div class="item-details">
            <h3>${name}</h3>
            <p>$${parseFloat(price).toFixed(2)}</p>
          </div>
          <div class="item-quantity-controls">
            <button class="quantity-button decrement-item">-</button>
            <span class="item-quantity">${qty}</span>
            <button class="quantity-button increment-item">+</button>
          </div>
          <button class="delete-item"><i class="fas fa-trash-alt"></i></button>
          <div class="item-price">$${total.toFixed(2)}</div>
        </div>
      `;
    }
    $list.html(html);
    const totalDue = subtotal + SERVICE_FEE + DELIVERY_FEE;
    $('#itemTotal').text(`$${subtotal.toFixed(2)}`);
    $('#cartTotal').text(`$${totalDue.toFixed(2)}`);

    $('.increment-item').off().on('click', e => {
      updateCart($(e.currentTarget).closest('.order-item').data('item-id'), +1);
    });
    $('.decrement-item').off().on('click', e => {
      updateCart($(e.currentTarget).closest('.order-item').data('item-id'), -1);
    });
    $('.delete-item').off().on('click', e => {
      deleteCartItem($(e.currentTarget).closest('.order-item').data('item-id'));
    });
  }

  function updateCart(id, delta) {
    const cart = JSON.parse(localStorage.getItem('cart') || '{}');
    if (!cart[id]) return;
    cart[id][0] += delta;
    if (cart[id][0] < 1) delete cart[id];
    localStorage.setItem('cart', JSON.stringify(cart));
    updateOrderDetails();
    updateCheckoutButtonState();
  }

  function deleteCartItem(id) {
    const cart = JSON.parse(localStorage.getItem('cart') || '{}');
    delete cart[id];
    localStorage.setItem('cart', JSON.stringify(cart));
    updateOrderDetails();
    updateCheckoutButtonState();
  }

  // ── Checkout Button State ──
  function updateCheckoutButtonState() {
    const cartEmpty = !Object.keys(JSON.parse(localStorage.getItem('cart') || '{}')).length;
    const paymentOK = !!selectedPaymentMethod;
    const addressOK = deliveryType === 'restaurant'
      ? true
      : (homeDeliveryAddress.full_name && homeDeliveryAddress.phone_number && homeDeliveryAddress.address);
    $checkoutButton.prop('disabled', cartEmpty || !paymentOK || !addressOK);
  }

      // ── Place Order Handler ──
    $checkoutButton.on('click', function (e) {
      e.preventDefault();
      $loadingOverlay.addClass('active');

      const cart = JSON.parse(localStorage.getItem('cart') || '{}');
      if (!Object.keys(cart).length) {
        alert('Your cart is empty.');
        return $loadingOverlay.removeClass('active');
      }
      if (!selectedPaymentMethod) {
        alert('Please select a payment method.');
        return $loadingOverlay.removeClass('active');
      }

      const payload = {
        delivery_type:    deliveryType,
        payment_method:   selectedPaymentMethod,
        cart,
        table_number:     tableNumber,
        delivery_details: deliveryType === 'home'
          ? { address: homeDeliveryAddress.address }
          : {},
        customer_details: deliveryType === 'home'
          ? {
              full_name:    homeDeliveryAddress.full_name,
              phone_number: homeDeliveryAddress.phone_number
            }
          : {}
      };

      console.log('Order payload:', payload);
      // TODO: Replace with real AJAX POST to your server endpoint
      // $.post('/your-order-endpoint/', payload).done(...).fail(...);

      // Simulate success
      setTimeout(() => {
        localStorage.removeItem('cart');
        window.location.href = '/order-success/';
      }, 1500);
    });

    // ── Initialization ──
    setDeliveryType();
    updateOrderDetails();
    updatePaymentOptions();
    updateCheckoutButtonState();
});
</script>



</body>
</html>