<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Delvrr Checkout</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jQuery first -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Mapbox Integration -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    {% load product_extras %}
    {% load static %}
    <!-- map.js after jQuery -->
    <script src="{% static 'menu_dashboard/js/map.js' %}"></script>
    {% csrf_token %}
    <style>
        :root {
            /* Base colors */
            --primary: {{ primary_brand_color }};
            --primary-rgb: {{ primary_brand_color|rgb_values }};
            
            /* Neutral shades - modern grayscale */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Monochromatic theme, less reliance on brand color */
            --accent: rgba(var(--primary-rgb), 0.95);
            --accent-light: rgba(var(--primary-rgb), 0.15);
            --accent-medium: rgba(var(--primary-rgb), 0.25);
            
            /* System colors */
            --background: #ffffff;
            --surface: #ffffff;
            --surface-off: #fafafa;
            --field: #f8f9fa;
            
            /* Text colors */
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --text-tertiary: var(--gray-500);
            --text-on-accent: {% if primary_brand_color|is_light %}var(--gray-900){% else %}white{% endif %};
            
            /* Feedback colors */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            
            /* Elevation */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 8px 12px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 12px 16px rgba(0, 0, 0, 0.1);
            
            /* Border radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            
            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            
            /* Typography */
            --font-xs: 11px;
            --font-sm: 13px;
            --font-md: 14px;
            --font-lg: 16px;
            --font-xl: 18px;
            --font-2xl: 20px;
            
            /* Safe areas */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            
            /* App dimensions */
            --header-height: 56px;
            --footer-height: 76px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: var(--font-md);
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--gray-50);
            overflow-x: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* App container */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            height: 100%;
            background: var(--background);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        /* Header */
        .app-header {
            position: sticky;
            top: 0;
            padding: calc(var(--safe-top) + var(--space-4)) var(--space-4) var(--space-4);
            background: var(--primary);
            z-index: 100;
            height: calc(var(--header-height) + var(--safe-top));
            display: flex;
            align-items: center;
            background-image: linear-gradient(to right, rgba(255,255,255,0.05), transparent);
        }

        .header-back {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: var(--font-md);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: var(--space-3);
            backdrop-filter: blur(4px);
        }

        .header-back:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .header-title {
            flex: 1;
        }

        .header-title h1 {
            font-size: var(--font-xl);
            font-weight: 600;
            color: white;
            margin: 0;
            letter-spacing: -0.01em;
        }

        .header-subtitle {
            font-size: var(--font-sm);
            color: rgba(255, 255, 255, 0.9);
            margin-top: 1px;
        }

        /* Progress indicator - Fixed alignment */
        .checkout-progress {
            display: flex;
            justify-content: space-between;
            padding: var(--space-4) var(--space-4) 0;
            position: relative;
            margin-bottom: var(--space-2);
        }

        .checkout-progress::before {
            content: '';
            position: absolute;
            top: calc(var(--space-4) + 12px);
            left: calc(var(--space-4) + 12px);
            right: calc(var(--space-4) + 12px);
            height: 2px;
            background: var(--gray-200);
            z-index: 1;
        }

        .progress-step {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-xs);
            font-weight: 700;
            color: var(--gray-500);
            z-index: 2;
            position: relative;
        }

        .progress-step.active {
            background: var(--primary);
            color: white;
        }

        .progress-step.completed {
            background: var(--success);
            color: white;
        }

        .progress-step.completed::after,
        .progress-step.active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 24px;
            right: 0;
            height: 2px;
            background: var(--success);
            transform: translateY(-50%);
            z-index: 1;
        }

        .progress-step:last-child::after {
            display: none;
        }

        /* Fixed progress labels alignment */
        .progress-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 var(--space-4);
            margin-bottom: var(--space-2);
        }

        .progress-label {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            text-align: center;
            width: 60px;
            margin: 0 -18px;
        }

        .progress-label.active {
            color: var(--primary);
            font-weight: 500;
        }

        /* Main content */
        .app-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(var(--footer-height) + var(--space-6));
        }

        /* Delivery options */
        .delivery-section {
            background: none;
            padding: var(--space-4);
        }

        .delivery-card {
            background: #fff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-6) var(--space-5) var(--space-5);
            border: none;
            max-width: 540px;
            margin: 0 auto var(--space-6);
            position: relative;
            overflow: hidden;
        }

        .delivery-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, var(--primary), transparent);
        }

        .delivery-selector {
            background: #f3f4f6;
            border-radius: 999px;
            display: flex;
            padding: 4px;
            position: relative;
            margin-bottom: var(--space-5);
            box-shadow: none;
            border: none;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .delivery-option {
            flex: 1;
            padding: 12px 8px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 1em;
            color: var(--text-secondary);
            background: none;
            z-index: 1;
            transition: all 0.2s ease;
            cursor: default;
            box-shadow: none;
            text-align: center;
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            pointer-events: none;
        }

        .delivery-option.active {
            color: #fff;
            background: var(--primary);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            position: relative;
        }

        .delivery-option i {
            font-size: 0.9em;
        }

        .delivery-slider { display: none !important; }

        .delivery-restaurant {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            animation: fadeIn 0.3s ease-out;
        }

        .delivery-restaurant i {
            font-size: var(--font-md);
            width: 32px;
            height: 32px;
            background: var(--accent-light);
            color: var(--primary);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delivery-restaurant p {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }

        .delivery-details-home {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .delivery-details-home.active {
            display: block;
        }

        .delivery-details-restaurant.inactive {
            display: none;
        }

        .address-button {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            background: linear-gradient(to right, var(--gray-50), white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin: 0 0 var(--space-3) 0;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .address-button:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--accent-light), var(--shadow-sm);
            transform: translateY(-1px);
        }

        .address-button .location {
            background: var(--accent-light);
            color: var(--primary);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            box-shadow: 0 2px 8px var(--accent-light);
        }

        .address-content {
            flex: 1;
            min-width: 0;
        }

        .address-title {
            font-weight: 600;
            font-size: 0.95em;
            color: var(--text-primary);
        }

        .address-desc {
            font-size: 0.9em;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chevron {
            color: var(--gray-400);
            font-size: 0.9em;
            padding: var(--space-1);
        }

        /* Map */
        #map-container {
            height: 0;
            overflow: hidden;
            transition: height 0.3s ease;
            border-radius: var(--radius-md);
            margin-top: var(--space-2);
            box-shadow: var(--shadow-md);
        }

        #map-container.active {
            height: 180px;
            margin-bottom: var(--space-3);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-sm);
        }

        .map-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-2);
        }

        .map-toggle {
            background: var(--primary);
            color: #fff;
            border-radius: var(--radius-full);
            padding: 8px 16px;
            font-weight: 600;
            font-size: 0.9em;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px var(--accent-light);
            transition: all 0.2s ease;
        }

        .map-toggle:hover {
            background: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 6px 14px var(--accent-light);
        }

        .map-toggle:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px var(--accent-light);
        }

        .delivery-time {
            background: var(--gray-100);
            color: var(--text-primary);
            border-radius: var(--radius-full);
            padding: 8px 14px;
            font-weight: 600;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            box-shadow: var(--shadow-sm);
        }

        .delivery-time i {
            color: var(--primary);
        }

        /* Content sections */
        .content-section {
            padding: var(--space-4);
        }

        .section-title {
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 32px;
            height: 3px;
            background: var(--primary);
            border-radius: var(--radius-full);
        }

        .section-title i {
            font-size: var(--font-md);
            color: var(--primary);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Order items - Enhanced design */
        .order-items {
            margin-bottom: var(--space-4);
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--surface);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            position: relative;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            transition: all 0.2s ease;
        }

        .order-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .item-image {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
            border: 2px solid white;
        }

        .item-details {
            flex: 1;
            min-width: 0;
            padding-right: var(--space-8);
        }

        .item-name {
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            margin-bottom: 2px;
        }

        .item-price {
            font-size: var(--font-sm);
            color: var(--primary);
            font-weight: 600;
        }

        .item-controls {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: var(--space-1);
            background: var(--gray-100);
            border-radius: var(--radius-full);
            padding: 4px;
            box-shadow: var(--shadow-sm);
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: var(--primary);
            font-size: var(--font-md);
            cursor: pointer;
            border-radius: var(--radius-full);
            font-weight: 600;
            transition: all 0.15s ease;
        }

        .qty-btn:active {
            background: var(--accent-light);
            color: var(--primary);
        }

        .qty-display {
            min-width: 28px;
            text-align: center;
            font-size: var(--font-sm);
            font-weight: 700;
            color: var(--text-primary);
        }

        .remove-item {
            position: absolute;
            right: 0;
            top: 0;
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.9);
            color: var(--error);
            border: 1px solid var(--gray-200);
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            transform: translate(50%, -50%);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .remove-item:hover {
            background: var(--error);
            color: white;
        }

        .remove-item:active {
            transform: translate(50%, -50%) scale(0.9);
        }

        /* Empty cart - Removed the Go to menu button */
        .empty-cart {
            padding: var(--space-8) var(--space-4);
            text-align: center;
            color: var(--text-tertiary);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-4);
        }

        .empty-cart i {
            font-size: 48px;
            opacity: 0.2;
        }

        .empty-cart p {
            font-size: var(--font-md);
            font-weight: 500;
        }

        /* Order summary */
        .summary-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
            overflow: hidden;
            margin-bottom: var(--space-4);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-sm);
        }

        .summary-row:not(:last-child) {
            border-bottom: 1px solid var(--gray-100);
        }

        .summary-row:last-child {
            background: linear-gradient(to right, var(--accent-light), white);
            font-weight: 600;
            padding: var(--space-4);
        }

        .summary-label {
            color: var(--text-secondary);
        }

        .summary-value {
            font-weight: 500;
        }

        .summary-total {
            font-weight: 700;
            color: var(--primary);
            font-size: var(--font-md);
        }

        /* Payment methods */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: var(--space-4);
            background: var(--surface);
            gap: var(--space-3);
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .payment-method:hover {
            background: var(--gray-50);
        }

        .payment-method.selected {
            background: var(--gray-50);
            border-left-color: var(--primary);
        }

        .payment-radio {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            display: inline-block;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .payment-method.selected .payment-radio {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--accent-light);
        }

        .payment-radio:after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: transparent;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.2s ease;
        }

        .payment-method.selected .payment-radio:after {
            background: var(--primary);
        }

        .payment-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-light);
            border-radius: var(--radius-md);
            color: var(--primary);
            flex-shrink: 0;
            font-size: var(--font-lg);
        }

        .payment-details {
            flex: 1;
            min-width: 0;
        }

        .payment-title {
            font-size: var(--font-md);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: 2px;
        }

        .payment-description {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }

        .payment-badge {
            font-size: 9px;
            padding: 2px 6px;
            background: var(--accent-light);
            color: var(--primary);
            border-radius: var(--radius-full);
            font-weight: 500;
        }

        /* Verification */
        #orderVerificationBox {
            display: none;
            margin-top: var(--space-4);
            animation: slideUp 0.3s ease-out;
        }

        .verification-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
            overflow: hidden;
        }

        .verification-header {
            padding: var(--space-3) var(--space-4);
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: var(--font-md);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .verification-content {
            padding: var(--space-4);
        }

        .verification-message {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-4);
        }

        .verification-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
            border-left: 3px solid var(--primary);
        }

        .total-label {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }

        .total-value {
            font-weight: 700;
            font-size: var(--font-lg);
            color: var(--primary);
        }

        .phone-label {
            font-size: var(--font-sm);
            font-weight: 500;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .phone-label i {
            color: var(--primary);
        }

        .phone-input {
            width: 100%;
            padding: var(--space-3);
            background: var(--field);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: var(--font-md);
            margin-bottom: var(--space-4);
            transition: all 0.2s ease;
        }

        .phone-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--accent-light);
        }

        .verify-button {
            width: 100%;
            padding: var(--space-3);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: var(--font-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            box-shadow: 0 4px 12px var(--accent-light);
            transition: all 0.2s ease;
        }

        .verify-button:hover {
            background: var(--accent);
            box-shadow: 0 6px 16px var(--accent-light);
            transform: translateY(-1px);
        }

        .verify-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px var(--accent-light);
        }

        .verify-button:disabled {
            opacity: 0.7;
            background: var(--gray-400);
            box-shadow: none;
            transform: none;
        }

        .verification-status {
            text-align: center;
            font-size: var(--font-sm);
            margin-top: var(--space-3);
            min-height: 20px;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .verification-status.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .verification-status.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* Footer */
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            z-index: 100;
            border-top: 1px solid var(--gray-100);
            padding: var(--space-4) var(--space-4) calc(var(--space-4) + var(--safe-bottom));
            height: calc(var(--footer-height) + var(--safe-bottom));
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.03);
        }

        .checkout-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: var(--space-3) var(--space-4);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: var(--font-md);
            cursor: pointer;
            box-shadow: 0 4px 12px var(--accent-light);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .checkout-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg, 
                rgba(255, 255, 255, 0) 0%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0) 100%
            );
            transition: all 0.8s ease;
        }

        .checkout-button:hover::before {
            left: 100%;
        }

        .checkout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--accent-light);
        }

        .checkout-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px var(--accent-light);
        }

        .checkout-button:disabled {
            opacity: 0.7;
            background: var(--gray-400);
            box-shadow: none;
            transform: none;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
            opacity: 0;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-container {
            width: 90%;
            max-width: 360px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            animation: modalSlideUp 0.3s forwards;
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(to right, var(--accent-light), white);
        }

        .modal-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: white;
            border: none;
            color: var(--gray-500);
            font-size: 18px;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--space-4);
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            font-size: var(--font-sm);
            font-weight: 600;
            margin-bottom: var(--space-2);
            display: block;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .form-label i {
            color: var(--primary);
            font-size: var(--font-sm);
        }

        .form-input {
            width: 100%;
            padding: var(--space-3);
            background: var(--field);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: var(--font-md);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--accent-light);
        }

        .form-actions {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-6);
        }

        .btn-cancel {
            flex: 1;
            padding: var(--space-3);
            background: var(--gray-100);
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: var(--font-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel:hover {
            background: var(--gray-200);
            color: var(--text-primary);
        }

        .btn-save {
            flex: 1;
            padding: var(--space-3);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: var(--font-sm);
            cursor: pointer;
            box-shadow: 0 4px 12px var(--accent-light);
            transition: all 0.2s ease;
        }

        .btn-save:hover {
            background: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px var(--accent-light);
        }

        .btn-save:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px var(--accent-light);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-6);
            text-align: center;
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            overflow: hidden;
            box-shadow: 0 8px 20px var(--accent-light);
            border: 4px solid white;
            animation: pulse 2s infinite ease-in-out;
        }

        .loading-title {
            font-weight: 700;
            font-size: var(--font-xl);
            color: var(--primary);
            margin-bottom: var(--space-2);
        }

        .loading-subtitle {
            font-size: var(--font-md);
            color: var(--text-secondary);
            max-width: 240px;
            margin-bottom: var(--space-3);
        }

        .loading-spinner {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-2);
        }

        .loading-dot {
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            animation: loading 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
        }

        .toast {
            background: rgba(31, 41, 55, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            border-left: 3px solid var(--primary);
        }

        .toast i {
            font-size: 16px;
        }

        .toast.loading i { 
            color: var(--info); 
            animation: spin 1s linear infinite; 
        }
        
        .toast.nearby i { 
            color: var(--success); 
        }
        
        .toast.far i { 
            color: var(--warning); 
        }
        
        .toast.error i { 
            color: var(--error); 
        }

        .toast.fade-out {
            opacity: 0;
            transform: translateX(30px);
        }

        @keyframes slideInRight {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Additional UI animations and effects */
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }

        /* User marker styling */
        .user-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #03a9f4;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            box-shadow: 0 0 0 rgba(3, 169, 244, 0.4);
            animation: pulse-blue 2s infinite;
        }
        
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(3, 169, 244, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(3, 169, 244, 0); }
            100% { box-shadow: 0 0 0 0 rgba(3, 169, 244, 0); }
        }

        /* Responsive styles */
        @media (max-width: 600px) {
            .delivery-card {
                padding: var(--space-5) var(--space-3) var(--space-4);
            }
            
            .address-button {
                padding: var(--space-3) var(--space-2);
            }
            
            .delivery-selector {
                padding: 4px;
                max-width: 100%;
            }
            
            .delivery-option {
                font-size: 0.9em;
                padding: 10px 0;
            }
        }

        /* Add compact styles for map actions */
        .compact-map-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .compact-map-actions .map-toggle,
        .compact-map-actions .delivery-time,
        .compact-map-actions .refresh-location-btn {
            padding: 4px 10px;
            font-size: 0.92em;
            min-height: 32px;
            height: 32px;
            border-radius: 16px;
            box-shadow: none;
            margin: 0;
        }
        .compact-map-actions .refresh-location-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .compact-map-actions .refresh-location-btn:hover {
            background: var(--accent);
        }
        .compact-map-actions .refresh-location-btn i {
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <button class="header-back" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-title">
                <h1>Checkout</h1>
                <div class="header-subtitle">Finalize your order</div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-content">
            <!-- Delivery Options -->
            <section class="delivery-section">
                <div class="delivery-card">
                    <div class="delivery-selector">
                        <div class="delivery-option" data-delivery-type="restaurant">
                            <i class="fas fa-utensils"></i>
                            <span>At Restaurant</span>
                        </div>
                        <div class="delivery-option" data-delivery-type="home">
                            <i class="fas fa-motorcycle"></i>
                            <span>Delivery</span>
                        </div>
                        <div class="delivery-slider"></div>
                    </div>

                    <div class="delivery-details">
                        <div class="delivery-details-restaurant">
                            <div class="delivery-restaurant">
                                <i class="fas fa-utensils"></i>
                                <p>Your order will be served at the restaurant</p>
                            </div>
                        </div>

                        <div class="delivery-details-home">
                            <button class="address-button" id="openAddressModal">
                                <i class="fas fa-map-marker-alt location"></i>
                                <div class="address-content">
                                    <div class="address-title">Delivery Address</div>
                                    <div class="address-desc">Add your delivery location</div>
                                </div>
                                <i class="fas fa-chevron-right chevron"></i>
                            </button>

                            <div id="map-container">
                                <div id="map"></div>
                            </div>

                            <div class="map-actions compact-map-actions">
                                <button class="map-toggle" onclick="toggleMap()">
                                    <i class="fas fa-map"></i>
                                    <span>View Map</span>
                                </button>
                                <div class="delivery-time">
                                    <i class="far fa-clock"></i>
                                    <span>~14 mins</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Order Items -->
            <section class="content-section">
                <div class="section-title">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Your Order</span>
                </div>

                <div class="order-items" id="orderDetailsList">
                    <!-- This will be populated by JS, showing example structure -->
                    <div class="order-item" data-item-id="1">
                        <img src="{% static 'menu_dashboard/placeholder.jpg' %}" alt="Food" class="item-image">
                        <div class="item-details">
                            <div class="item-name">Spicy Chicken Sandwich</div>
                            <div class="item-price">$9.99</div>
                        </div>
                        <div class="item-controls">
                            <button class="qty-btn decrement-item">-</button>
                            <span class="qty-display">1</span>
                            <button class="qty-btn increment-item">+</button>
                        </div>
                        <button class="remove-item" aria-label="Remove item">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="order-item" data-item-id="2">
                        <img src="{% static 'menu_dashboard/placeholder.jpg' %}" alt="Food" class="item-image">
                        <div class="item-details">
                            <div class="item-name">French Fries with Cheese Dip</div>
                            <div class="item-price">$4.99</div>
                        </div>
                        <div class="item-controls">
                            <button class="qty-btn decrement-item">-</button>
                            <span class="qty-display">2</span>
                            <button class="qty-btn increment-item">+</button>
                        </div>
                        <button class="remove-item" aria-label="Remove item">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Example of empty cart state, will be shown if cart is empty -->
                    <!--
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                    </div>
                    -->
                </div>

                <!-- Order Summary -->
                <div class="summary-card">
                    <div class="summary-row">
                        <div class="summary-label">Subtotal</div>
                        <div class="summary-value" id="itemTotal">$19.97</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Service Fee</div>
                        <div class="summary-value">$0.25</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Delivery Fee</div>
                        <div class="summary-value">$0.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Total</div>
                        <div class="summary-value summary-total" id="cartTotal">$20.22</div>
                    </div>
                </div>
            </section>

            <!-- Payment Methods -->
            <section class="content-section">
                <div class="section-title">
                    <i class="fas fa-wallet"></i>
                    <span>Payment Method</span>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="cash">
                        <div class="payment-radio"></div>
                        <div class="payment-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-title">Cash on Delivery</div>
                            <div class="payment-description">Pay when your food arrives</div>
                        </div>
                    </div>
                    
                    <div class="payment-method disabled" data-method="card">
                        <div class="payment-radio"></div>
                        <div class="payment-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-title">Card Payment <span class="payment-badge">Soon</span></div>
                            <div class="payment-description">Pay with your card</div>
                        </div>
                    </div>
                    
                    <div class="payment-method disabled" data-method="orange_money">
                        <div class="payment-radio"></div>
                        <div class="payment-icon">
                            <img src="{% static 'menu_dashboard/orange_money.png' %}" alt="Orange Money" width="18" height="18">
                        </div>
                        <div class="payment-details">
                            <div class="payment-title">Orange Money <span class="payment-badge">Soon</span></div>
                            <div class="payment-description">Mobile payment</div>
                        </div>
                    </div>
                </div>
                
                <!-- Verification Box -->
                <div id="orderVerificationBox">
                    <div class="verification-card">
                        <div class="verification-header">
                            <i class="fas fa-shield-alt"></i>
                            <span>Verify Your Order</span>
                        </div>
                        <div class="verification-content">
                            <div class="verification-message">
                                Confirm your phone number to ensure quick delivery
                            </div>
                            
                            <div class="verification-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value" id="ov-total-amount">$20.22</span>
                            </div>
                            
                            <div class="phone-label">
                                <i class="fas fa-phone-alt"></i>
                                <span>Your Phone Number</span>
                            </div>
                            <input type="tel" class="phone-input" id="ov-phone-input" placeholder="Enter phone number">
                            
                            <button class="verify-button" id="ov-verify-btn">
                                <i class="fas fa-check-circle"></i>
                                Verify
                            </button>
                            
                            <div class="verification-status" id="verificationStatus"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <button 
                id="checkoutButton" 
                class="checkout-button"
                data-restaurant-lat="{{ restaurant.latitude }}"
                data-restaurant-lon="{{ restaurant.longitude }}"
                data-restaurant-name-slug="{{ restaurant.slug }}"
                data-restaurant-hashed-slug="{{ restaurant.hashed_slug }}">
                <i class="fas fa-check-circle"></i>
                Place Order
            </button>
        </footer>
    </div>

    <!-- Address Modal -->
    <div class="modal-overlay" id="addressModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Delivery Address</h2>
                <button class="modal-close" id="closeAddressModal" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="deliveryAddressForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label" for="modal-full-name">
                            <i class="fas fa-user"></i>
                            <span>Full Name</span>
                        </label>
                        <input type="text" id="modal-full-name" class="form-input" placeholder="Your full name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="modal-phone-number">
                            <i class="fas fa-phone-alt"></i>
                            <span>Phone Number</span>
                        </label>
                        <input type="tel" id="modal-phone-number" class="form-input" placeholder="Your phone number">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="modal-address">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Address</span>
                        </label>
                        <input type="text" id="modal-address" class="form-input" placeholder="Your delivery address">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" id="cancelAddress">Cancel</button>
                        <button type="button" class="btn-save" id="saveAddress">Save Address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Verifying Order</h2>
                <button class="modal-close" id="closePaymentModal" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="paymentVerificationProgress" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                    <div style="width: 48px; height: 48px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="text-align: center; font-weight: 500;">Verifying your order...</p>
                </div>
                
                <div id="paymentVerificationSuccess" style="display: none; text-align: center; padding: 20px 0;">
                    <i class="fas fa-check-circle" style="font-size: 56px; color: var(--success); margin-bottom: 16px;"></i>
                    <p style="font-weight: 600; margin-bottom: 8px; font-size: 18px;">Order verified successfully!</p>
                    <p style="font-size: var(--font-sm); color: var(--text-secondary);">Our team will call you shortly</p>
                </div>
                
                <div id="paymentVerificationFailed" style="display: none; text-align: center; padding: 20px 0;">
                    <i class="fas fa-times-circle" style="font-size: 56px; color: var(--error); margin-bottom: 16px;"></i>
                    <p style="font-weight: 600; margin-bottom: 8px; font-size: 18px;">Verification failed</p>
                    <p style="font-size: var(--font-sm); color: var(--text-secondary);">Please check your details and try again</p>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button id="tryAgainPayment" class="btn-cancel" style="display: none;">Try Again</button>
                    <button id="continueToCheckout" class="btn-save" style="display: none;">Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-logo">
                <img src="{% static 'menu_dashboard/delvrr.JPG' %}" alt="Delvrr Logo" width="80" height="80">
            </div>
            <div>
                <div class="loading-title">Processing your order</div>
                <div class="loading-subtitle">Please wait while we confirm your order details</div>
            </div>
            <div class="loading-spinner">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // Function to toggle map visibility
        function toggleMap() {
            const mapContainer = document.getElementById('map-container');
            const mapToggle = document.querySelector('.map-toggle span');
            
            if (!mapContainer) return;
            
            if (mapContainer.classList.contains('active')) {
                mapContainer.classList.remove('active');
                mapToggle.textContent = 'View Map';
            } else {
                mapContainer.classList.add('active');
                mapToggle.textContent = 'Hide Map';
            }
        }

        // Enhanced toast notifications
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-info-circle';
            if (type === 'loading') icon = 'fa-spinner';
            else if (type === 'nearby') icon = 'fa-check-circle';
            else if (type === 'far') icon = 'fa-truck';
            else if (type === 'error') icon = 'fa-exclamation-circle';
            
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            container.appendChild(toast);
            
            let toastId;
            
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('fade-out');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            } else {
                toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
                toast.id = toastId;
            }
            
            return toastId;
        }
        
        // Function to remove a specific toast by ID
        function removeToast(toastId) {
            if (!toastId) return;
            
            const toast = document.getElementById(toastId);
            if (!toast) return;
            
            toast.classList.add('fade-out');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
        
        // Function to update UI based on delivery type
        function updateDeliveryTypeUI() {
            if (!state) return;
            
            // Update delivery option UI
            const restaurantOption = document.querySelector('.delivery-option[data-delivery-type="restaurant"]');
            const homeOption = document.querySelector('.delivery-option[data-delivery-type="home"]');
            
            if (restaurantOption && homeOption) {
                // Remove active class from both options
                restaurantOption.classList.remove('active');
                homeOption.classList.remove('active');
                
                // Add active class to the selected option
                if (state.deliveryType === 'restaurant') {
                    restaurantOption.classList.add('active');
                } else {
                    homeOption.classList.add('active');
                }
            }
            
            // Update visibility of restaurant/delivery details
            const restaurantDetails = document.querySelector('.delivery-details-restaurant');
            const homeDetails = document.querySelector('.delivery-details-home');
            const verificationBox = document.getElementById('orderVerificationBox');
            
            if (state.deliveryType === 'home') {
                restaurantDetails.classList.add('inactive');
                homeDetails.classList.add('active');
                if (verificationBox) verificationBox.style.display = 'block';
            } else {
                homeDetails.classList.remove('active');
                restaurantDetails.classList.remove('inactive');
                if (verificationBox) verificationBox.style.display = 'none';
            }
            
            // Update payment options based on delivery type
            if (typeof updatePaymentOptions === 'function') {
                updatePaymentOptions();
            }
        }

        // Function to update the cart items display with animation
        function updateOrderDetailsEnhanced() {
            const cart = getCart();
            const items = Object.entries(cart);
            const orderDetailsList = document.getElementById('orderDetailsList');
            
            if (!orderDetailsList) return;
            
            if (!items.length) {
                // Show empty cart message - without the Go to menu button
                orderDetailsList.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                    </div>
                `;
                document.getElementById('itemTotal').textContent = '$0.00';
                document.getElementById('cartTotal').textContent = '$0.00';
                return;
            }
            
            let html = '';
            let subtotal = 0;
            
            items.forEach(([id, item]) => {
                const qty = item[0];
                const name = item[1];
                const price = item[2];
                const img = item[3];
                
                const itemPrice = parseFloat(price);
                const total = qty * itemPrice;
                subtotal += total;
                
                html += `
                    <div class="order-item" data-item-id="${id}">
                        <img src="${img}" alt="${name}" class="item-image">
                        <div class="item-details">
                            <div class="item-name">${name}</div>
                            <div class="item-price">$${itemPrice.toFixed(2)}</div>
                        </div>
                        <div class="item-controls">
                            <button class="qty-btn decrement-item">-</button>
                            <span class="qty-display">${qty}</span>
                            <button class="qty-btn increment-item">+</button>
                        </div>
                        <button class="remove-item" onclick="deleteCartItem('${id}')" aria-label="Remove item">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            
            orderDetailsList.innerHTML = html;
            
            // Update the summary values with animation
            const totalDue = subtotal + 0.25; // Adding service fee
            const itemTotalEl = document.getElementById('itemTotal');
            const cartTotalEl = document.getElementById('cartTotal');
            
            if (itemTotalEl.textContent !== `$${subtotal.toFixed(2)}`) {
                itemTotalEl.classList.add('pulse');
                itemTotalEl.textContent = `$${subtotal.toFixed(2)}`;
                setTimeout(() => itemTotalEl.classList.remove('pulse'), 1000);
            }
            
            if (cartTotalEl.textContent !== `$${totalDue.toFixed(2)}`) {
                cartTotalEl.classList.add('pulse');
                cartTotalEl.textContent = `$${totalDue.toFixed(2)}`;
                setTimeout(() => cartTotalEl.classList.remove('pulse'), 1000);
            }
            
            // If verification box is visible, update the verification amount
            const verificationAmount = document.getElementById('ov-total-amount');
            if (verificationAmount) {
                verificationAmount.textContent = `$${totalDue.toFixed(2)}`;
            }
            
            // Update checkout button state
            if (typeof updateCheckoutButtonState === 'function') {
                updateCheckoutButtonState();
            }
        }

        // Override for the updateMapWithUserLocation function
        // This will be called instead of the original function when map.js loads
        const originalUpdateMapWithUserLocation = window.updateMapWithUserLocation;
        
        window.updateMapWithUserLocation = function(force = false) {
            if (!state || !state.isMapInitialized) {
                // If original function exists and we're not initialized, call it
                if (typeof originalUpdateMapWithUserLocation === 'function') {
                    return originalUpdateMapWithUserLocation(force);
                }
                return;
            }
            
            // Prevent multiple simultaneous updates
            if (state.locationUpdateQueued && !force) return;
            state.locationUpdateQueued = true;
            
            getUserLocation(1, false).then(userLoc => {
                state.locationUpdateQueued = false;
                
                if (state.userMarker) {
                    // Update existing marker position
                    state.userMarker.setLngLat(userLoc);
                } else {
                    // Create new user marker
                    const userMarkerEl = document.createElement('div');
                    userMarkerEl.className = 'user-marker';
                    userMarkerEl.innerHTML = '<i class="fas fa-user fa-sm"></i>';
                    
                    state.userMarker = new mapboxgl.Marker({ element: userMarkerEl })
                        .setLngLat(userLoc)
                        .addTo(state.map);
                }

                // Only adjust bounds if needed or not yet done
                if (!state.mapBoundsAdjusted || force) {
                    const bounds = new mapboxgl.LngLatBounds()
                        .extend(userLoc)
                        .extend(state.restaurantLocation);
                        
                    state.map.fitBounds(bounds, { 
                        padding: { top: 50, bottom: 50, left: 50, right: 50 },
                        duration: 300 // Faster animation
                    });
                    
                    state.mapBoundsAdjusted = true;
                }

                // Calculate and update distance
                state.distanceToRestaurant = calculateDistance(userLoc, state.restaurantLocation);
                
                // Determine delivery type based SOLELY on distance
                const isAtRestaurant = state.distanceToRestaurant <= THRESHOLD_DISTANCE;
                
                // Get old delivery type to check if we need to show a toast
                const oldDeliveryType = state.deliveryType;
                
                // Update state with new delivery type
                state.deliveryType = isAtRestaurant ? 'restaurant' : 'home';
                
                // If delivery type has changed, update UI and show a toast
                if (oldDeliveryType !== state.deliveryType || force) {
                    // Update UI
                    updateDeliveryTypeUI();
                    
                    // Show appropriate toast - only if type changed or forced
                    if (isAtRestaurant) {
                        showToast('You are at the restaurant! Order will be served here.', 'nearby', 3000);
                    } else {
                        showToast(`You are ${formatDistance(state.distanceToRestaurant)} from restaurant.`,'far', 3000);
                    }
                }
                
                // Update distance display if it exists
                if (typeof updateDistanceDisplay === 'function') {
                    updateDistanceDisplay(state.distanceToRestaurant);
                }
                
                // Update delivery time if needed
                if (state.deliveryType === 'home' && typeof updateDeliveryTime === 'function') {
                    updateDeliveryTime(state.distanceToRestaurant);
                }
            }).catch(err => {
                state.locationUpdateQueued = false;
                console.error('Error updating map:', err);
                showToast('Could not determine your location. Please enable location services.', 'error', 5000);
                
                // Default to home delivery if location fails
                state.deliveryType = 'home';
                updateDeliveryTypeUI();
            });
        };

        // Main initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI elements
            const deliveryOptions = document.querySelectorAll('.delivery-option');
            const paymentMethods = document.querySelectorAll('.payment-method:not(.disabled)');
            
            // Address modal elements
            const addressModal = document.getElementById('addressModal');
            const openAddressBtn = document.getElementById('openAddressModal');
            const closeAddressBtn = document.getElementById('closeAddressModal');
            const saveAddressBtn = document.getElementById('saveAddress');
            const cancelAddressBtn = document.getElementById('cancelAddress');
            
            // Verification elements
            const verifyBtn = document.getElementById('ov-verify-btn');
            const verificationModal = document.getElementById('paymentModal');
            const closeVerificationBtn = document.getElementById('closePaymentModal');
            const continueBtn = document.getElementById('continueToCheckout');
            const tryAgainBtn = document.getElementById('tryAgainPayment');
            
            // Checkout button
            const checkoutButton = document.getElementById('checkoutButton');
            
            // Progress indicators
            const progressSteps = document.querySelectorAll('.progress-step');
            const progressLabels = document.querySelectorAll('.progress-label');
            
            // Disable delivery options clicking - make them indicators only
            deliveryOptions.forEach(option => {
                option.style.cursor = 'default';
                option.style.pointerEvents = 'none';
            });
            
            // Setup payment method selection with enhanced visuals
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    // Ignore if disabled
                    if (this.classList.contains('disabled')) return;
                    
                    // Add haptic feedback
                    if ('vibrate' in navigator) navigator.vibrate(50);
                    
                    // Visual feedback
                    this.classList.add('pulse');
                    setTimeout(() => this.classList.remove('pulse'), 1000);
                    
                    paymentMethods.forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // Update state in map.js if it exists
                    if (typeof state !== 'undefined') {
                        state.selectedPaymentMethod = this.getAttribute('data-method');
                        if (typeof updateCheckoutButtonState === 'function') {
                            updateCheckoutButtonState();
                        }
                    }
                    
                    // Show toast notification about payment selection
                    showToast(`Selected ${this.querySelector('.payment-title').textContent}`, 'info');
                });
            });
            
            // Address modal setup with improved animations
            if (openAddressBtn && addressModal) {
                openAddressBtn.addEventListener('click', function() {
                    addressModal.classList.add('active');
                    
                    // Focus the first input field for better UX
                    setTimeout(() => {
                        const firstInput = addressModal.querySelector('.form-input');
                        if (firstInput) firstInput.focus();
                    }, 300);
                });
            }
            
            if (closeAddressBtn) {
                closeAddressBtn.addEventListener('click', function() {
                    addressModal.classList.remove('active');
                });
            }
            
            if (cancelAddressBtn) {
                cancelAddressBtn.addEventListener('click', function() {
                    addressModal.classList.remove('active');
                });
            }
            
            if (saveAddressBtn) {
                saveAddressBtn.addEventListener('click', function() {
                    const fullName = document.getElementById('modal-full-name').value.trim();
                    const phoneNumber = document.getElementById('modal-phone-number').value.trim();
                    const address = document.getElementById('modal-address').value.trim();
                    
                    if (!fullName || !phoneNumber || !address) {
                        // Enhanced error feedback
                        const emptyFields = [];
                        if (!fullName) emptyFields.push('name');
                        if (!phoneNumber) emptyFields.push('phone number');
                        if (!address) emptyFields.push('address');
                        
                        showToast(`Please enter your ${emptyFields.join(', ')}`, 'error');
                        return;
                    }
                    
                    // Visual feedback
                    saveAddressBtn.classList.add('pulse');
                    
                    // Update state in map.js if it exists
                    if (typeof state !== 'undefined') {
                        state.homeDeliveryAddress = {
                            full_name: fullName,
                            phone_number: phoneNumber,
                            address: address
                        };
                        
                        // Update the address button text with animation
                        const addressDesc = document.querySelector('.address-button .address-desc');
                        if (addressDesc) {
                            addressDesc.classList.add('pulse');
                            addressDesc.textContent = address;
                            setTimeout(() => addressDesc.classList.remove('pulse'), 1000);
                        }
                        
                        // Update verification phone input if empty
                        const verificationPhone = document.getElementById('ov-phone-input');
                        if (verificationPhone && !verificationPhone.value.trim()) {
                            verificationPhone.value = phoneNumber;
                        }
                        
                        if (typeof updateCheckoutButtonState === 'function') {
                            updateCheckoutButtonState();
                        }
                    }
                    
                    // Show success toast
                    showToast('Delivery address saved!', 'nearby');
                    
                    addressModal.classList.remove('active');
                    setTimeout(() => saveAddressBtn.classList.remove('pulse'), 1000);
                });
            }

            // Enhanced verification UX
            if (verifyBtn && verificationModal) {
                verifyBtn.addEventListener('click', function() {
                    const phoneNumber = document.getElementById('ov-phone-input').value.trim();
                    const verificationStatus = document.getElementById('verificationStatus');
                    
                    if (!phoneNumber || phoneNumber.length < 8) {
                        if (verificationStatus) {
                            verificationStatus.textContent = 'Please enter a valid phone number';
                            verificationStatus.className = 'verification-status error';
                        }
                        
                        // Visual feedback for error
                        const phoneInput = document.getElementById('ov-phone-input');
                        phoneInput.classList.add('shake');
                        setTimeout(() => phoneInput.classList.remove('shake'), 800);
                        
                        return;
                    }
                    
                    // Visual feedback
                    verifyBtn.classList.add('pulse');
                    setTimeout(() => verifyBtn.classList.remove('pulse'), 1000);
                    
                    verificationModal.classList.add('active');
                    document.getElementById('paymentVerificationProgress').style.display = 'flex';
                    document.getElementById('paymentVerificationSuccess').style.display = 'none';
                    document.getElementById('paymentVerificationFailed').style.display = 'none';
                    document.getElementById('continueToCheckout').style.display = 'none';
                    document.getElementById('tryAgainPayment').style.display = 'none';
                    
                    // Simulate verification process with feedback
                    setTimeout(() => {
                        document.getElementById('paymentVerificationProgress').style.display = 'none';
                        document.getElementById('paymentVerificationSuccess').style.display = 'block';
                        document.getElementById('continueToCheckout').style.display = 'block';
                        
                        // Update verification status
                        if (verificationStatus) {
                            verificationStatus.innerHTML = '<i class="fas fa-check-circle"></i> Verification successful';
                            verificationStatus.className = 'verification-status success';
                        }
                        
                        // Update state in map.js if it exists
                        if (typeof state !== 'undefined') {
                            state.paymentVerified = true;
                            if (typeof updateCheckoutButtonState === 'function') {
                                updateCheckoutButtonState();
                            }
                        }
                    }, 1500);
                });
            }
            
            // Payment modal handlers with improved UX
            if (closeVerificationBtn) {
                closeVerificationBtn.addEventListener('click', () => {
                    verificationModal.classList.remove('active');
                });
            }
            
            if (continueToCheckout) {
                continueToCheckout.addEventListener('click', () => {
                    verificationModal.classList.remove('active');
                    
                    // Show success toast
                    showToast('Order verified successfully!', 'nearby');
                    
                    // Update progress steps
                    if (progressSteps.length >= 3) {
                        progressSteps[1].classList.add('completed');
                        progressSteps[1].innerHTML = '<i class="fas fa-check"></i>';
                        progressSteps[2].classList.add('active');
                    }
                });
            }
            
            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', () => {
                    verificationModal.classList.remove('active');
                });
            }

            // Add swipe gestures for cart items with enhanced feedback
            const orderDetailsList = document.getElementById('orderDetailsList');
            if (orderDetailsList) {
                let touchStartX = 0;
                let touchEndX = 0;
                
                orderDetailsList.addEventListener('touchstart', function(e) {
                    if (e.target.closest('.order-item')) {
                        touchStartX = e.touches[0].clientX;
                    }
                }, { passive: true });
                
                orderDetailsList.addEventListener('touchmove', function(e) {
                    if (e.target.closest('.order-item')) {
                        touchEndX = e.touches[0].clientX;
                    }
                }, { passive: true });
                
                orderDetailsList.addEventListener('touchend', function(e) {
                    const orderItem = e.target.closest('.order-item');
                    if (!orderItem) return;
                    
                    const swipeDistance = touchStartX - touchEndX;
                    
                    if (swipeDistance > 100) {
                        // Swipe left - delete with animation
                        orderItem.style.transform = 'translateX(-100%)';
                        orderItem.style.opacity = '0';
                        
                        // Add haptic feedback
                        if ('vibrate' in navigator) navigator.vibrate([40, 30, 40]);
                        
                        setTimeout(() => {
                            if (typeof deleteCartItem === 'function') {
                                deleteCartItem(orderItem.getAttribute('data-item-id'));
                            }
                        }, 300);
                    } else if (swipeDistance < -100) {
                        // Swipe right - increment
                        orderItem.classList.add('pulse');
                        setTimeout(() => orderItem.classList.remove('pulse'), 500);
                        
                        // Add haptic feedback
                        if ('vibrate' in navigator) navigator.vibrate(30);
                        
                        if (typeof updateCart === 'function') {
                            updateCart(orderItem.getAttribute('data-item-id'), 1);
                        }
                    }
                });
            }

            // Checkout button handler with enhanced feedback
            if (checkoutButton) {
                checkoutButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (typeof getCart !== 'function') return;
                    
                    const cart = getCart();
                    
                    if (!Object.keys(cart).length) {
                        showToast('Your cart is empty', 'error');
                        return;
                    }
                    
                    if (typeof state === 'undefined' || !state.selectedPaymentMethod) {
                        showToast('Please select a payment method', 'error');
                        return;
                    }
                    
                    // Visual feedback - show button press effect
                    checkoutButton.classList.add('pulse');
                    
                    if (state.deliveryType === 'home' && state.selectedPaymentMethod === 'Cash on Delivery') {
                        if (!state.homeDeliveryAddress || !state.homeDeliveryAddress.full_name || !state.homeDeliveryAddress.phone_number || !state.homeDeliveryAddress.address) {
                            showToast('Please enter your delivery address', 'error');
                            if (openAddressBtn) {
                                setTimeout(() => {
                                    openAddressBtn.click();
                                }, 300);
                            }
                            
                            setTimeout(() => checkoutButton.classList.remove('pulse'), 1000);
                            return;
                        }
                        
                        if (!state.paymentVerified) {
                            showToast('Please verify your order first', 'error');
                            if (verifyBtn) {
                                setTimeout(() => {
                                    const verificationBox = document.getElementById('orderVerificationBox');
                                    if (verificationBox) {
                                        verificationBox.scrollIntoView({ behavior: 'smooth' });
                                        verifyBtn.classList.add('shake');
                                        setTimeout(() => verifyBtn.classList.remove('shake'), 800);
                                    }
                                }, 300);
                            }
                            
                            setTimeout(() => checkoutButton.classList.remove('pulse'), 1000);
                            return;
                        }
                        
                        if (!state.adminConfirmed && !state.adminConfirmationInProgress) {
                            if (typeof requestAdminConfirmation === 'function') {
                                requestAdminConfirmation();
                            } else {
                                showToast('Restaurant confirmation required', 'info');
                            }
                            setTimeout(() => checkoutButton.classList.remove('pulse'), 1000);
                            return;
                        }
                        
                        if (state.adminConfirmationInProgress && !state.adminConfirmed) {
                            showToast('Please wait for restaurant confirmation', 'loading');
                            setTimeout(() => checkoutButton.classList.remove('pulse'), 1000);
                            return;
                        }
                    }

                    // Show loading overlay with enhanced animation
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.classList.add('active');
                        
                        // More descriptive loading experience
                        const loadingTitle = loadingOverlay.querySelector('.loading-title');
                        if (loadingTitle) {
                            loadingTitle.textContent = 'Processing your order';
                        }
                        
                        const loadingSubtitle = loadingOverlay.querySelector('.loading-subtitle');
                        if (loadingSubtitle) {
                            loadingSubtitle.textContent = state.deliveryType === 'home' 
                                ? 'Preparing delivery to your location...' 
                                : 'Your order will be ready for pickup soon...';
                        }
                    }
                    
                    // Prepare the checkout data
                    const formData = {
                        cart: JSON.stringify(cart),
                        payment_method: state.selectedPaymentMethod,
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                    };
                    
                    console.log('Sending order data:', formData);
                    
                    const restaurantSlug = checkoutButton.getAttribute('data-restaurant-name-slug');
                    const hashedSlug = checkoutButton.getAttribute('data-restaurant-hashed-slug');
                    const checkoutUrl = `/menu/${restaurantSlug}/${hashedSlug}/checkout/`;

                    // Process checkout
                    setTimeout(() => {
                        $.ajax({
                            url: checkoutUrl,
                            type: 'POST',
                            data: formData,
                            headers: { 'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val() },
                            success: (response) => {
                                if (response.order_id) {
                                    const orderId = response.order_id;
                                    const successUrl = `/menu/${restaurantSlug}/${hashedSlug}/${orderId}/order_success/`;
                                    
                                    // Update progress steps before redirect
                                    if (progressSteps.length >= 3) {
                                        progressSteps[2].classList.add('completed');
                                        progressSteps[2].innerHTML = '<i class="fas fa-check"></i>';
                                    }
                                    
                                    // Ensure minimum load time for better UX
                                    setTimeout(() => {
                                        // Change loading message before redirect
                                        const loadingTitle = loadingOverlay.querySelector('.loading-title');
                                        if (loadingTitle) {
                                            loadingTitle.textContent = 'Order Successful!';
                                        }
                                        
                                        const loadingSubtitle = loadingOverlay.querySelector('.loading-subtitle');
                                        if (loadingSubtitle) {
                                            loadingSubtitle.textContent = 'Redirecting to order confirmation...';
                                        }
                                        
                                        setTimeout(() => {
                                            // Keep loading overlay visible until redirect
                                            window.location.href = successUrl;
                                            localStorage.removeItem('cart');
                                        }, 800);
                                    }, 1500);
                                } else {
                                    console.error('Order failed:', response);
                                    if (loadingOverlay) {
                                        loadingOverlay.classList.remove('active');
                                    }
                                    
                                    // Show error toast
                                    showToast('Failed to place order: ' + (response.message || 'Unknown error'), 'error');
                                    checkoutButton.classList.remove('pulse');
                                }
                            },
                            error: (xhr) => {
                                console.error('Order error:', xhr);
                                if (loadingOverlay) {
                                    loadingOverlay.classList.remove('active');
                                }
                                
                                // Show error toast
                                const msg = xhr.responseJSON?.message || xhr.statusText || 'Unknown error';
                                showToast('Error placing order: ' + msg, 'error');
                                checkoutButton.classList.remove('pulse');
                            }
                        });
                    }, 500); // Small delay to show button animation
                });
            }

            // Override the original updateOrderDetails function if it exists
            if (typeof updateOrderDetails === 'function') {
                window.originalUpdateOrderDetails = updateOrderDetails;
                window.updateOrderDetails = updateOrderDetailsEnhanced;
                
                // Initialize order display
                updateOrderDetailsEnhanced();
            }
            
            // Show location detection toast
            const loadingToastId = showToast('Detecting your location...', 'loading', 0);
            
            // Initialize map and location
            if (typeof initializeMap === 'function') {
                initializeMap()
                    .then(() => {
                        // Remove loading toast once map is ready
                        removeToast(loadingToastId);
                        
                        // showToast('Location services activated', 'nearby', 2000);
                        
                        // Add location refresh button near the map
                        const mapActions = document.querySelector('.map-actions');
                        // Initialize map and location
                    if (typeof initializeMap === 'function') {
                        initializeMap()
                            .then(() => {
                                // Remove loading toast once map is ready
                                removeToast(loadingToastId);
                                
                                showToast('Location services activated', 'nearby', 2000);
                                
                                // No refresh button will be added
                            })
                            .catch(err => {
                                console.error('Map initialization error:', err);
                                
                                // Remove loading toast if there was an error
                                removeToast(loadingToastId);
                                
                                showToast('Could not access your location. Please enable location services.', 'error', 5000);
                                
                                // Default to delivery mode when location fails
                                if (typeof state !== 'undefined') {
                                    state.deliveryType = 'home';
                                    updateDeliveryTypeUI();
                                }
                            });
                    }
                    });
            } else {
                // If map initialization isn't available, remove loading toast
                // If map initialization isn't available, remove loading toast
                removeToast(loadingToastId);
                
                console.error('Map initialization function not found');
                showToast('Map functionality not available', 'error', 3000);
                
                // Default to delivery mode
                if (typeof state !== 'undefined') {
                    state.deliveryType = 'home';
                    updateDeliveryTypeUI();
                }
            }
            
            // Ensure cart is loaded
            if (typeof ensureCartLoaded === 'function') {
                ensureCartLoaded();
            }
        });
        
        // Function to handle item quantity control clicks (fallback if event delegation fails)
        document.addEventListener('click', function(e) {
            // Increment button
            if (e.target.classList.contains('increment-item') || e.target.closest('.increment-item')) {
                const orderItem = e.target.closest('.order-item');
                if (orderItem && typeof updateCart === 'function') {
                    const itemId = orderItem.getAttribute('data-item-id');
                    updateCart(itemId, 1);
                    
                    // Add visual and haptic feedback
                    if ('vibrate' in navigator) navigator.vibrate(30);
                }
            }
            
            // Decrement button
            if (e.target.classList.contains('decrement-item') || e.target.closest('.decrement-item')) {
                const orderItem = e.target.closest('.order-item');
                if (orderItem && typeof updateCart === 'function') {
                    const itemId = orderItem.getAttribute('data-item-id');
                    updateCart(itemId, -1);
                    
                    // Add visual and haptic feedback
                    if ('vibrate' in navigator) navigator.vibrate(30);
                }
            }
            
            // Remove button
            if (e.target.classList.contains('remove-item') || e.target.closest('.remove-item')) {
                const orderItem = e.target.closest('.order-item');
                if (orderItem && typeof deleteCartItem === 'function') {
                    const itemId = orderItem.getAttribute('data-item-id');
                    
                    // Animate item removal
                    orderItem.style.transform = 'translateX(-100%)';
                    orderItem.style.opacity = '0';
                    
                    // Add haptic feedback
                    if ('vibrate' in navigator) navigator.vibrate([40, 30, 40]);
                    
                    setTimeout(() => {
                        deleteCartItem(itemId);
                    }, 300);
                }
            }
        });
    </script>
</body>
</html>