<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Delvrr Checkout</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Mapbox Integration -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <style>
        :root {
            --primary: #2e7d32;
            --primary-gradient: linear-gradient(135deg, #2e7d32, #1b5e20);
            --surface: #ffffff;
            --surface-alt: #f1f8e9;
            --text: #212121;
            --text-secondary: #757575;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --accent: #03a9f4;
            --input-border: #ced4da;
            --input-focus-border: var(--primary);
            --input-bg: #f8f9fa;
            --modal-bg: rgba(0, 0, 0, 0.5);
            --modal-inner-bg: var(--surface);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--surface-alt);
            color: var(--text);
            line-height: 1.5;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 400px;
            margin: 10px auto;
            min-height: calc(100vh - 20px);
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--surface);
            padding: calc(0.8rem + var(--safe-area-top)) 1rem 0.8rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            padding: 6px;
            border-radius: var(--radius-sm);
        }

        .back-button:active {
            opacity: 0.7;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
        }

        .delivery-options {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .delivery-options-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
            color: var(--text);
        }

        .delivery-switch-container {
            display: flex;
            background-color: #f9f9f9;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .delivery-switch-label {
            padding: 0.8rem 1.2rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            user-select: none;
            text-align: center;
            flex-grow: 1;
        }

        .delivery-switch-label.active {
            background-color: var(--primary);
            color: white;
        }

        .delivery-details {
            padding: 1rem;
        }

        .delivery-details-home {
            display: none;
        }

        .delivery-details-home.active {
            display: block;
        }

        .delivery-details-restaurant {
            display: block;
        }

        .delivery-details-restaurant.inactive {
            display: none;
        }

        .table-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background-color: #f0f7f2;
            padding: 0.8rem;
            border-radius: var(--radius-sm);
        }

        .table-info i {
            color: var(--accent);
            font-size: 1rem;
        }

        .delivery-address-button {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            color: var(--text);
            cursor: pointer;
            padding: 0;
        }

        .delivery-address-button i {
            font-size: 1rem;
            color: var(--accent);
        }

        .delivery-address-button:active {
            opacity: 0.8;
        }

        .address-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .address-modal.active {
            display: flex;
        }

        .address-modal-content {
            background-color: var(--modal-inner-bg);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .address-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .address-modal-header h2 {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text);
            margin: 0;
        }

        .close-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .close-button:active {
            opacity: 0.7;
        }

        .address-form > div {
            margin-bottom: 1rem;
        }

        .address-form label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.2rem;
        }

        .address-form input[type="text"],
        .address-form input[type="tel"] {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid var(--input-border);
            border-radius: var(--radius-sm);
            background-color: var(--input-bg);
            font-size: 0.85rem;
            color: var(--text);
            transition: border-color 0.2s ease;
        }

        .address-form input[type="text"]:focus,
        .address-form input[type="tel"]:focus {
            border-color: var(--input-focus-border);
            outline: none;
        }

        .address-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .address-actions button {
            padding: 0.7rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s ease;
        }

        .address-actions button:active {
            opacity: 0.8;
        }

        .address-actions .save-address {
            background-color: var(--primary);
            color: white;
        }

        .address-actions .cancel-address {
            background-color: var(--surface-alt);
            color: var(--text-secondary);
            border: 1px solid var(--input-border);
        }

        .estimated-delivery {
            font-size: 0.75rem;
            color: #558b2f;
            font-style: italic;
            margin-top: 0.6rem;
        }

        .order-section {
            padding: 1rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
            color: var(--text);
        }

        .order-item {
            background-color: var(--surface);
            border-radius: var(--radius-sm);
            margin-bottom: 0.4rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.05);
            font-size: 0.8rem;
        }

        .order-item img {
            width: 36px;
            height: 36px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            background-color: #eee;
        }

        .item-details {
            flex-grow: 1;
        }

        .item-details h3 {
            font-size: 0.85rem;
            margin-bottom: 0.1rem;
        }

        .item-details p {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0;
        }

        .item-quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: auto;
        }

        .quantity-button {
            background: none;
            border: 1px solid var(--input-border);
            border-radius: var(--radius-sm);
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .quantity-button:active {
            opacity: 0.7;
        }

        .item-quantity {
            font-weight: 500;
            font-size: 0.8rem;
            width: 20px;
            text-align: center;
        }

        .delete-item {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .delete-item:active {
            opacity: 0.7;
        }

        /* Enhanced Payment Methods CSS */
.payment-methods {
  padding: 1.25rem;
  border-top: 1px solid #e0e0e0;
  background-color: #f9f9f9;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.payment-methods-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: var(--text);
  position: relative;
  padding-bottom: 0.5rem;
}

.payment-methods-title:after {
  content: '';
  position: absolute;
  left: 0;
  bottom: 0;
  width: 40px;
  height: 3px;
  background-color: var(--primary);
  border-radius: 3px;
}

.payment-option {
  display: none; /* Hidden by default */
  background-color: var(--surface);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.75rem;
  align-items: center;
  gap: 1rem;
  cursor: pointer;
  border: 2px solid #e0e0e0;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.payment-option.active {
  display: flex; /* Shown when active */
}

.payment-option.selected {
  border-color: var(--primary);
  background-color: rgba(var(--primary-rgb, 46, 125, 50), 0.08);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.payment-option:hover:not(.selected) {
  border-color: #bdbdbd;
  background-color: #f5f5f5;
}

.payment-icon {
  background-color: #e8f5e9;
  color: var(--primary);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.payment-option.selected .payment-icon {
  transform: scale(1.1);
  background-color: var(--primary);
  color: white;
}

.payment-details {
  flex: 1;
}

.payment-details h3 {
  font-size: 0.95rem;
  margin-bottom: 0.25rem;
  font-weight: 600;
  color: var(--text);
}

.payment-details p {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin: 0;
}

/* Mobile Money Form Styling */
.mobile-money-form {
  display: none;
  padding: 1rem;
  margin-top: 1rem;
  background-color: white;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.payment-info-box {
  background-color: #f0f7ff;
  border: 1px solid #cce0ff;
  border-radius: 8px;
  margin-bottom: 1.25rem;
  overflow: hidden;
}

.payment-header {
  background-color: #e6f0ff;
  padding: 0.75rem 1rem;
  font-weight: 600;
  color: #0056b3;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.payment-info-content {
  padding: 1rem;
}

.restaurant-number {
  font-size: 0.9rem;
  margin-bottom: 0.75rem;
  color: #333;
}

.payment-note {
  font-size: 0.8rem;
  color: #555;
  margin-bottom: 0.75rem;
}

.amount-box {
  background-color: white;
  border: 1px dashed #aaa;
  border-radius: 6px;
  padding: 0.75rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0.75rem;
}

.amount {
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--primary);
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.4rem;
  font-size: 0.85rem;
  color: #555;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.9rem;
  transition: border-color 0.2s ease;
}

.form-control:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 2px rgba(var(--primary-rgb, 46, 125, 50), 0.2);
}

.transaction-verification {
  margin-top: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.btn {
  padding: 0.75rem 1rem;
  border: none;
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
}

.btn-verify {
  background-color: var(--primary);
  color: white;
}

.btn-verify:hover {
  background-color: rgba(var(--primary-rgb, 46, 125, 50), 0.9);
  transform: translateY(-2px);
}

.btn-success {
  background-color: #4caf50;
  color: white;
}

.btn-secondary {
  background-color: #f5f5f5;
  color: #333;
}

.verification-status {
  min-height: 24px;
  font-size: 0.85rem;
  text-align: center;
  padding: 0.25rem;
}

/* Payment Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background-color: white;
  width: 90%;
  max-width: 420px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h2 {
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0;
}

.close-modal {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #777;
}

.modal-body {
  padding: 1.5rem;
}

.verification-progress {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  padding: 1rem 0;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(var(--primary-rgb, 46, 125, 50), 0.2);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.verification-result {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  padding: 1rem 0;
  text-align: center;
}

.verification-result i {
  font-size: 3rem;
}

.verification-result.success i {
  color: #4caf50;
}

.verification-result.failed i {
  color: #f44336;
}

.modal-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
}
/* Additional CSS for the new Cash on Delivery verification system */
.order-verification-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background-color: #4caf50;
  color: white;
  font-size: 0.7rem;
  padding: 3px 8px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

textarea.form-control {
  resize: vertical;
  min-height: 60px;
}

.form-check {
  display: flex;
  align-items: center;
  margin-bottom: 1rem;
  gap: 8px;
}

.form-check input {
  margin: 0;
  width: 18px;
  height: 18px;
}

.form-check label {
  margin: 0;
  font-size: 0.85rem;
  color: #555;
}


        .checkout-bar {
            background-color: var(--surface);
            padding: 0.7rem 1rem calc(0.7rem + var(--safe-area-bottom));
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -0.5px 1px rgba(0, 0, 0, 0.05);
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .total-amount {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .total-amount p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .total-amount span {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text);
        }

        .checkout-button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.8rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .checkout-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .checkout-button:active:not(:disabled) {
            transform: scale(0.98);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-cart {
            padding: 1.5rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-cart i {
            font-size: 1.5rem;
            margin-bottom: 0.6rem;
        }

        html {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        input,
        textarea,
        select {
            font-size: 16px !important;
            line-height: 1.4;
        }

        .address-modal-content input,
        .address-modal-content textarea {
            font-size: 16px !important;
            line-height: 1.4;
        }
        /* Add these styles to your existing CSS */
 #map-container {
      height: 0;
      overflow: hidden;
      transition: height 0.3s ease;
      margin-top: 10px;
      border-radius: var(--radius-md);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    #map-container.active {
      height: 200px;
      margin-bottom: 15px;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .map-toggle {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 0;
      margin-top: 5px;
      cursor: pointer;
    }
    .distance-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 10px 0;
      padding: 10px;
      background-color: #f0f7f2;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
    }
    .distance-indicator i { color: var(--accent); }
    .distance-status { font-weight: 500; }
    .distance-status.nearby { color: #2e7d32; }
    .distance-status.far    { color: #ff6f00; }
    .mapboxgl-popup {
      max-width: 200px;
    }
    .mapboxgl-popup-content {
      text-align: center;
      padding: 10px;
      font-family: 'Poppins', sans-serif;
    }

    </style>
</head>
<body>
     <div class="app-container">
    <header class="header">
      <button class="back-button" onclick="window.history.back()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1>Checkout</h1>
      <div></div>
    </header>

    <section class="delivery-options">
      <h2 class="delivery-options-title">Delivery</h2>
      <div class="delivery-switch-container">
        <div class="delivery-switch-label active" data-delivery-type="restaurant">
          At Restaurant
        </div>
        <div class="delivery-switch-label" data-delivery-type="home">
          Home
        </div>
      </div>
    </section>

    <div class="delivery-details">
      <div class="delivery-details-restaurant">
        <div class="table-info">
          <i class="fas fa-chair"></i>
          Your food will be delivered to <strong>Table 1</strong>.
        </div>
        <div class="distance-indicator" id="distanceIndicator">
          <i class="fas fa-map-marker-alt"></i>
          <div>
            <span class="distance-value">Detecting your location...</span>
            <div class="distance-status" id="distanceStatus"></div>
          </div>
        </div>
      </div>

      <div class="delivery-details-home">
        <button class="delivery-address-button" id="openAddressModal">
          <i class="fas fa-map-marker-alt"></i>
          Delivery Address
        </button>
        <p class="estimated-delivery">
          <i class="far fa-clock"></i> ~14 mins
        </p>
      </div>

      <!-- ← Always-visible map controls ↓ -->
      <div class="map-wrapper">
        <button class="map-toggle" id="toggleMap">
          <i class="fas fa-map"></i> Show map
        </button>
        <div id="map-container">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <section class="order-section">
      <h2 class="section-title">Your Order</h2>
      <div id="orderDetailsList">
        <div class="empty-cart">
          <i class="fas fa-shopping-bag"></i>
          <p>Your cart is empty.</p>
        </div>
      </div>
    </section>

    <!-- Enhanced Payment Methods HTML Section -->
<!-- Enhanced Payment Methods HTML Section -->
<section class="payment-methods">
  <h2 class="payment-methods-title">Payment Method</h2>
  
  <!-- Restaurant payment options -->
  <div class="payment-option restaurant-only" data-method="Cash on Delivery">
    <div class="payment-icon"><i class="fas fa-money-bill-alt"></i></div>
    <div class="payment-details">
      <h3>Cash on Delivery</h3>
      <p>Pay in cash when your food arrives</p>
    </div>
  </div>
  
  <!-- Home delivery payment options -->
  <div class="payment-option home-only" data-method="Cash on Delivery" id="cashDeliveryOption">
    <div class="payment-icon"><i class="fas fa-money-bill-alt"></i></div>
    <div class="payment-details">
      <h3>Cash on Delivery</h3>
      <p>Pay in cash when your food arrives</p>
    </div>
  </div>
  
  <!-- Order Verification Form for home delivery -->
  <div id="orderVerificationForm" class="mobile-money-form">
    <div class="payment-info-box">
      <div class="payment-header">
        <i class="fas fa-info-circle"></i> Order Verification
      </div>
      <div class="payment-info-content">
        <p class="payment-note">To ensure your delivery arrives promptly, please verify your order with a quick phone confirmation</p>
        <div class="amount-box">
          <span>Total Amount:</span>
          <span id="mobileMoneyAmount" class="amount">$0.00</span>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="confirmPhone">Confirm Your Phone Number</label>
      <input type="tel" id="confirmPhone" class="form-control" placeholder="Enter your number" required>
    </div>
    
    <div class="transaction-verification">
      <button id="verifyOrder" class="btn btn-verify">
        <i class="fas fa-check-circle"></i> Verify Order
      </button>
      <div id="verificationStatus" class="verification-status"></div>
    </div>
  </div>
</section>
<!-- Order Verification Modal -->
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Verifying Order</h2>
      <button id="closePaymentModal" class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <div id="paymentVerificationProgress" class="verification-progress">
        <div class="spinner"></div>
        <p>Verifying your order...</p>
      </div>
      <div id="paymentVerificationSuccess" class="verification-result success">
        <i class="fas fa-check-circle"></i>
        <p>Order verified successfully!</p>
        <small>Our team will call you shortly to confirm your order</small>
      </div>
      <div id="paymentVerificationFailed" class="verification-result failed">
        <i class="fas fa-times-circle"></i>
        <p>Verification failed. Please check your details and try again.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button id="continueToCheckout" class="btn btn-success">Continue to Checkout</button>
      <button id="tryAgainPayment" class="btn btn-secondary">Try Again</button>
    </div>
  </div>
</div>

    <div class="checkout-bar">
      <div class="total-amount">
        <p>Item total</p>
        <span id="itemTotal">$0.00</span>
      </div>
      <div class="total-amount">
        <p>To Pay</p>
        <span id="cartTotal" style="font-size:1.1rem; font-weight:600;">$0.00</span>
      </div>
     <button
        id="checkoutButton"
        class="checkout-button"
        data-restaurant-lat="{{ restaurant.latitude }}"
        data-restaurant-lon="{{ restaurant.longitude }}"
        data-restaurant-name-slug="{{ restaurant.slug }}"
        data-restaurant-hashed-slug="{{ restaurant.hashed_slug }}"
        disabled
    >
        <i class="fas fa-check-circle"></i> Place Order
    </button>
    </div>

    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <div class="address-modal" id="addressModal">
      <div class="address-modal-content">
        <div class="address-modal-header">
          <h2>Enter Delivery Address</h2>
          <button class="close-button" id="closeAddressModal">×</button>
        </div>
        <form class="address-form" id="deliveryAddressForm">
          <div>
            <label for="full-name">Full Name:</label>
            <input type="text" id="modal-full-name" placeholder="Your Full Name">
          </div>
          <div>
            <label for="phone-number">Phone Number:</label>
            <input type="tel" id="modal-phone-number" placeholder="Your Phone Number">
          </div>
          <div>
            <label for="address">Address:</label>
            <input type="text" id="modal-address" placeholder="Your Street Address">
          </div>
          <div class="address-actions">
            <button type="button" class="cancel-address" id="cancelAddress">Cancel</button>
            <button type="button" class="save-address"   id="saveAddress">Save Address</button>
          </div>
        </form>
      </div>
    </div>
  </div>


    <div id="toast-container" class="toast-container"></div>
     <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
   <script>
   $(document).ready(function () {
    // ── Constants & State ──
    const SERVICE_FEE = 0.25;
    const DELIVERY_FEE = 0.00;
    const THRESHOLD_DISTANCE = 100; // meters
    const RESTAURANT_MOBILE_MONEY = "0123456789";
    const ADMIN_CONFIRMATION_TIMEOUT = 60000; // 60 seconds timeout for admin confirmation

    // Read & round restaurant coords once
    const restaurantLat = parseFloat(parseFloat($('#checkoutButton').attr('data-restaurant-lat')).toFixed(8));
    const restaurantLon = parseFloat(parseFloat($('#checkoutButton').attr('data-restaurant-lon')).toFixed(8));
    const restaurantLocation = [restaurantLon, restaurantLat];

    // Application state
    const state = {
        selectedPaymentMethod: '',
        deliveryType: 'unknown',
        homeDeliveryAddress: {},
        paymentVerified: false,
        adminConfirmed: false,
        adminConfirmationInProgress: false,
        orderReferenceId: null,
        tableNumber: '1',
        userLocation: null,
        isMapInitialized: false,
        map: null,
        userMarker: null,
        restaurantMarker: null,
        distanceToRestaurant: null
    };

    // ── Cache DOM Elements (once, at initialization) ──
    const elements = {
        checkoutButton: $('#checkoutButton'),
        openAddressModal: $('#openAddressModal'),
        addressModal: $('#addressModal'),
        closeAddressModal: $('#closeAddressModal'),
        saveAddress: $('#saveAddress'),
        cancelAddress: $('#cancelAddress'),
        loadingOverlay: $('#loading-overlay'),
        orderVerificationForm: $('#orderVerificationForm'),
        paymentModal: $('#paymentModal'),
        closePaymentModal: $('#closePaymentModal'),
        continueToCheckout: $('#continueToCheckout'),
        tryAgainPayment: $('#tryAgainPayment'),
        verifyOrder: $('#verifyOrder'),
        verificationStatus: $('#verificationStatus'),
        totalAmount: $('#mobileMoneyAmount'),
        confirmPhone: $('#confirmPhone'),
       
        modalFullName: $('#modal-full-name'),
        modalPhoneNumber: $('#modal-phone-number'),
        modalAddress: $('#modal-address'),
        mapContainer: document.getElementById('map-container'),
        toggleMapButton: document.getElementById('toggleMap'),
        distanceValue: $('.distance-value'),
        distanceStatus: $('#distanceStatus'),
        orderDetailsList: $('#orderDetailsList'),
        itemTotal: $('#itemTotal'),
        cartTotal: $('#cartTotal'),
        deliverySwitchLabels: $('.delivery-switch-label'),
        paymentOptions: $('.payment-option'),
        adminConfirmationModal: $('#adminConfirmationModal'),
        adminConfirmationStatus: $('#adminConfirmationStatus'),
        adminConfirmationProgress: $('#adminConfirmationProgress'),
        closeAdminConfirmation: $('#closeAdminConfirmation'),
        tryAgainAdminConfirmation: $('#tryAgainAdminConfirmation'),
        orderReferenceDisplay: $('#orderReferenceDisplay'),
        confirmationTimeRemaining: $('#confirmationTimeRemaining')
    };

    // ── Helper Functions ──

    // Generate a unique reference ID for orders
    function generateOrderReferenceId() {
        const timestamp = new Date().getTime().toString().slice(-6);
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        return `ORD-${timestamp}-${random}`;
    }

    // Calculate straight-line distance
    function calculateDistance(userLoc, restLoc) {
        if (typeof turf === 'undefined' || !turf.point || !turf.distance) {
            console.error("Turf.js library not loaded!");
            return Infinity;
        }
        return turf.distance(turf.point(userLoc), turf.point(restLoc), { units: 'meters' });
    }

    // Update distance display UI
    function updateDistanceDisplay(dist) {
        if (dist === Infinity) {
            elements.distanceValue.text('Could not calculate distance');
            elements.distanceStatus.text('');
            elements.distanceStatus.removeClass('nearby far');
            return;
        }
        
        elements.distanceValue.text(dist < 1000
            ? `${Math.round(dist)} meters away`
            : `${(dist / 1000).toFixed(1)} km away`
        );
        
        elements.distanceStatus
            .text(dist <= THRESHOLD_DISTANCE
                ? "You're at the restaurant!"
                : "Delivery recommended"
            )
            .toggleClass('nearby', dist <= THRESHOLD_DISTANCE)
            .toggleClass('far', dist > THRESHOLD_DISTANCE);
    }

    // Get user location as a Promise - with caching
    function getUserLocation() {
        // Return cached location if available
        if (state.userLocation) {
            return Promise.resolve(state.userLocation);
        }
        
        return new Promise((res, rej) => {
            if (!navigator.geolocation) {
                rej('No geolocation support');
            } else {
                navigator.geolocation.getCurrentPosition(
                    p => {
                        // Cache the user location
                        state.userLocation = [p.coords.longitude, p.coords.latitude];
                        res(state.userLocation);
                    },
                    e => rej(e),
                    // Add options for faster response
                    { maximumAge: 60000, timeout: 5000, enableHighAccuracy: false }
                );
            }
        });
    }

    // Lazy load Mapbox initialization
    function initializeMap() {
        if (state.isMapInitialized) return Promise.resolve();
        
        return new Promise((resolve, reject) => {
            // Defer map initialization to not block page loading
            requestAnimationFrame(() => {
                try {
                    mapboxgl.accessToken = 'pk.eyJ1IjoibWl0Y2hlbGwyMzEiLCJhIjoiY205dGF0YXprMGFoajJrc2I5cDVvNnprZSJ9.LiQvQKUCOIe5fW0QYSOSFQ';
                    state.map = new mapboxgl.Map({
                        container: 'map',
                        style: 'mapbox://styles/mapbox/streets-v11',
                        center: restaurantLocation,
                        zoom: 14
                    });
                    
                    state.map.on('load', () => {
                        // Add restaurant marker
                        const restaurantEl = document.createElement('div');
                        restaurantEl.innerHTML = '<i class="fas fa-utensils fa-2x"></i>';
                        restaurantEl.style.color = '#d32f2f';
                        restaurantEl.style.textShadow = '0 0 3px #fff';
                        
                        state.restaurantMarker = new mapboxgl.Marker({ element: restaurantEl })
                            .setLngLat(restaurantLocation)
                            .setPopup(new mapboxgl.Popup().setHTML('<strong>Restaurant</strong>'))
                            .addTo(state.map);
                            
                        state.isMapInitialized = true;
                        resolve();
                        
                        // Get user location for map and add user marker/route
                        updateMapWithUserLocation();
                    });
                    
                    state.map.on('error', (e) => {
                        console.error('Mapbox error:', e.error);
                        reject(e.error);
                    });
                } catch (err) {
                    console.error('Map initialization error:', err);
                    reject(err);
                }
            });
        });
    }

    // Update map with user location (separated from initialization)
    async function updateMapWithUserLocation() {
        if (!state.isMapInitialized) return;
        
        try {
            const userLoc = await getUserLocation();
            
            // Add/update user marker
            const userEl = document.createElement('div');
            userEl.innerHTML = '<i class="fas fa-user fa-2x"></i>';
            userEl.style.color = '#1976d2';
            userEl.style.textShadow = '0 0 3px #fff';
            
            if (state.userMarker) state.userMarker.remove();
            
            state.userMarker = new mapboxgl.Marker({ element: userEl })
                .setLngLat(userLoc)
                .setPopup(new mapboxgl.Popup().setHTML('<strong>Your Location</strong>'))
                .addTo(state.map);

            // Fit map bounds to include both markers
            const bounds = new mapboxgl.LngLatBounds()
                .extend(userLoc)
                .extend(restaurantLocation);
                
            state.map.fitBounds(bounds, { padding: 70 });

            // Draw route line - efficiently update existing or create new
            const routeGeoJSON = {
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: [userLoc, restaurantLocation]
                }
            };
            
            if (state.map.getSource('route')) {
                state.map.getSource('route').setData(routeGeoJSON);
            } else {
                state.map.addSource('route', { type: 'geojson', data: routeGeoJSON });
                state.map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: 'route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#03a9f4', 'line-width': 3, 'line-dasharray': [2, 1] }
                });
            }

            // Calculate and cache distance
            state.distanceToRestaurant = calculateDistance(userLoc, restaurantLocation);
            updateDistanceDisplay(state.distanceToRestaurant);

        } catch (err) {
            console.error('Geo error for map:', err);
            elements.distanceValue.text('Could not determine your location for map');
            elements.distanceStatus.text('').removeClass('nearby far');
        }
    }

    // Determine and set delivery type based on user location
    async function setDeliveryType() {
        try {
            // Get user location (cached if available)
            const userLoc = await getUserLocation();
            const dist = calculateDistance(userLoc, restaurantLocation);
            state.distanceToRestaurant = dist;

            const isAtRestaurant = dist < THRESHOLD_DISTANCE;
            state.deliveryType = isAtRestaurant ? 'restaurant' : 'home';

            // Update UI based on delivery type
            if (isAtRestaurant) {
                $('.delivery-details-restaurant').show();
                $('.delivery-details-home').hide();
                elements.mapContainer.classList.remove('active');
                elements.toggleMapButton.innerHTML = '<i class="fas fa-map"></i> Show map';
                
                // No verification needed for eat-in orders
                state.paymentVerified = true;
                state.adminConfirmed = true; // No admin confirmation needed for eat-in
                elements.orderVerificationForm.hide();
                $('#cashDeliveryOption .order-verification-badge').remove();
                elements.verificationStatus.empty();
            } else {
                $('.delivery-details-home').show();
                $('.delivery-details-restaurant').hide();
                
                // Initialize map asynchronously without blocking UI
                setTimeout(() => {
                    if (!elements.mapContainer.classList.contains('active')) {
                        elements.mapContainer.classList.add('active');
                        elements.toggleMapButton.innerHTML = '<i class="fas fa-map"></i> Hide map';
                    }
                    initializeMap();
                }, 100);
                
                // Show verification form for home delivery
                state.paymentVerified = false;
                state.adminConfirmed = false;
                elements.orderVerificationForm.show();
                
                // Update total amount for verification form
                updateOrderTotalAmountDisplay(calculateCartTotal());
            }

            // Update switch labels UI
            elements.deliverySwitchLabels.removeClass('active');
            $(`.delivery-switch-label[data-delivery-type="${state.deliveryType}"]`).addClass('active');

            // Update other UI elements (without unnecessary duplicate calls)
            updatePaymentOptions();
            
            // Update distance display if we have distance information
            if (state.distanceToRestaurant !== null) {
                updateDistanceDisplay(state.distanceToRestaurant);
            }
            
        } catch (err) {
            console.warn('Could not get user location, defaulting to Home delivery.', err);
            // Fallback to home delivery
            state.deliveryType = 'home';
            $('.delivery-details-home').show();
            $('.delivery-details-restaurant').hide();
            
            // Initialize map centered on restaurant
            setTimeout(() => {
                if (!elements.mapContainer.classList.contains('active')) {
                    elements.mapContainer.classList.add('active');
                    elements.toggleMapButton.innerHTML = '<i class="fas fa-map"></i> Hide map';
                }
                initializeMap();
                updateDistanceDisplay(Infinity);
            }, 100);
            
            // Update UI for home delivery
            elements.deliverySwitchLabels.removeClass('active');
            $(`.delivery-switch-label[data-delivery-type="${state.deliveryType}"]`).addClass('active');
            
            updatePaymentOptions();
        }
    }

    // ── Admin Confirmation Logic ──
    
    // Request admin confirmation for cash-on-delivery orders
    function requestAdminConfirmation() {
        if (state.adminConfirmationInProgress) return;
        
        state.adminConfirmationInProgress = true;
        state.adminConfirmed = false;
        state.orderReferenceId = generateOrderReferenceId();
        
        // Show admin confirmation modal
        elements.adminConfirmationModal.css('display', 'flex');
        elements.adminConfirmationProgress.show();
        elements.adminConfirmationStatus.html('<span>Waiting for restaurant to confirm your order...</span>');
        elements.orderReferenceDisplay.text(state.orderReferenceId);
        elements.tryAgainAdminConfirmation.hide();
        
        let timeRemaining = ADMIN_CONFIRMATION_TIMEOUT / 1000;
        elements.confirmationTimeRemaining.text(timeRemaining);
        
        // Update countdown timer
        const countdownInterval = setInterval(() => {
            timeRemaining--;
            elements.confirmationTimeRemaining.text(timeRemaining);
            
            if (timeRemaining <= 0) {
                clearInterval(countdownInterval);
            }
        }, 1000);

        // In a real app, you would make an API call to notify the restaurant admin
        // and set up a websocket or polling to check for confirmation
        // For demo purposes, we'll simulate the admin response
        
        const simulateAdminResponse = () => {
            // 80% chance of approval in this demo
            const isApproved = Math.random() < 0.8;
            
            clearInterval(countdownInterval);
            elements.adminConfirmationProgress.hide();
            
            if (isApproved) {
                elements.adminConfirmationStatus.html('<span style="color: #4caf50;"><i class="fas fa-check-circle"></i> Restaurant confirmed your order! You can now proceed.</span>');
                state.adminConfirmed = true;
                $('#cashDeliveryOption').append('<span class="admin-confirmation-badge"><i class="fas fa-check-circle"></i> Confirmed by Restaurant</span>');
                elements.tryAgainAdminConfirmation.hide();
                
                // Add a "Continue" button that closes the modal
                const continueButton = $('<button id="continueAfterConfirmation" class="primary-button">Continue to Checkout</button>');
                elements.adminConfirmationStatus.append(continueButton);
                
                $('#continueAfterConfirmation').on('click', function() {
                    elements.adminConfirmationModal.hide();
                    state.adminConfirmationInProgress = false;
                    updateCheckoutButtonState();
                });
            } else {
                elements.adminConfirmationStatus.html('<span style="color: #f44336;"><i class="fas fa-times-circle"></i> Restaurant could not confirm your order at this time. Please try again or contact the restaurant.</span>');
                state.adminConfirmed = false;
                elements.tryAgainAdminConfirmation.show();
            }
            
            updateCheckoutButtonState();
        };
        
        // Simulate admin response after a random time between 5-15 seconds
        setTimeout(simulateAdminResponse, 5000 + Math.random() * 10000);
    }

    // ── Cart Management ──
    
    // Calculate cart total (extracted to be reusable)
    function calculateCartTotal() {
        const cart = JSON.parse(localStorage.getItem('cart') || '{}');
        let subtotal = 0;
        
        Object.entries(cart).forEach(([id, item]) => {
            subtotal += item[0] * parseFloat(item[2]);
        });
        
        return subtotal + SERVICE_FEE + DELIVERY_FEE;
    }

    // Update cart display and totals - with optimized DOM updates
    function updateOrderDetails() {
        const cart = JSON.parse(localStorage.getItem('cart') || '{}');
        const items = Object.entries(cart);
        
        // Handle empty cart case
        if (!items.length) {
            elements.orderDetailsList.html(`
                <div class="empty-cart">
                    <i class="fas fa-shopping-bag"></i>
                    <p>Your cart is empty.</p>
                </div>
            `);
            elements.itemTotal.text('$0.00');
            elements.cartTotal.text('$0.00');
            updateCheckoutButtonState();
            return;
        }

        // Prepare HTML for all items at once (single DOM update)
        let html = '';
        let subtotal = 0;

        items.forEach(([id, item]) => {
            const [qty, name, price, img] = item;
            const itemPrice = parseFloat(price);
            const total = qty * itemPrice;
            subtotal += total;
            
            html += `
                <div class="order-item" data-item-id="${id}" data-item-price="${itemPrice.toFixed(2)}">
                    <img src="${img}" alt="${name}">
                    <div class="item-details">
                        <h3>${name}</h3>
                        <p>$${itemPrice.toFixed(2)}</p>
                    </div>
                    <div class="item-quantity-controls">
                        <button class="quantity-button decrement-item">-</button>
                        <span class="item-quantity">${qty}</span>
                        <button class="quantity-button increment-item">+</button>
                    </div>
                    <button class="delete-item"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
        });

        // Single DOM update for entire cart
        elements.orderDetailsList.html(html);

        const totalDue = subtotal + SERVICE_FEE + DELIVERY_FEE;
        elements.itemTotal.text(`$${subtotal.toFixed(2)}`);
        elements.cartTotal.text(`$${totalDue.toFixed(2)}`);

        // Update payment modal if visible
        if (elements.orderVerificationForm.is(':visible')) {
            updateOrderTotalAmountDisplay(totalDue);
        }

        updateCheckoutButtonState();
    }

    // Update cart logic (handles increment, decrement, delete internally)
    function updateCart(id, delta) {
        const cart = JSON.parse(localStorage.getItem('cart') || '{}');
        if (!cart[id]) return;

        cart[id][0] += delta; // Update quantity
        if (cart[id][0] < 1) {
            delete cart[id]; // Remove item if quantity is less than 1
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Provide haptic feedback if available 
        if ('vibrate' in navigator) navigator.vibrate(30);
        
        // Update UI after cart change
        updateOrderDetails();
    }

    // Delete item from cart
    function deleteCartItem(id) {
        const cart = JSON.parse(localStorage.getItem('cart') || '{}');
        if (!cart[id]) return;

        delete cart[id];
        localStorage.setItem('cart', JSON.stringify(cart));
        
        if ('vibrate' in navigator) navigator.vibrate(50);
        
        updateOrderDetails();
    }

    // Update visibility and selection of payment options
    function updatePaymentOptions() {
        // Reset selected method first
        state.selectedPaymentMethod = '';
        elements.paymentOptions.removeClass('selected active');

        if (state.deliveryType === 'restaurant') {
            $('.payment-option.restaurant-only').addClass('active');
            // Auto-select Cash for restaurant orders
            $('.payment-option[data-method="Cash on Delivery"].restaurant-only').addClass('selected');
            state.selectedPaymentMethod = 'Cash on Delivery';
            elements.orderVerificationForm.hide();
            state.paymentVerified = true;
            state.adminConfirmed = true; // No admin confirmation needed for eat-in
            $('#cashDeliveryOption .order-verification-badge').remove();
            elements.verificationStatus.empty();
        } else {
            $('.payment-option.home-only').addClass('active');
            // Auto-select Cash on Delivery for home delivery
            $('.payment-option[data-method="Cash on Delivery"].home-only').addClass('selected');
            state.selectedPaymentMethod = 'Cash on Delivery';
            elements.orderVerificationForm.show();
            state.paymentVerified = false;
            state.adminConfirmed = false;
            
            // Update total amount in verification form
            updateOrderTotalAmountDisplay(calculateCartTotal());
        }
        
        updateCheckoutButtonState();
    }

    // Update the total amount displayed in the payment verification section
    function updateOrderTotalAmountDisplay(amount) {
        elements.totalAmount.text(`$${amount.toFixed(2)}`);
    }

    // Update the state (enabled/disabled) and text of the checkout button
    function updateCheckoutButtonState() {
        const cart = JSON.parse(localStorage.getItem('cart') || '{}');
        const cartEmpty = !Object.keys(cart).length;
        const paymentSelected = !!state.selectedPaymentMethod;
        const addressEntered = state.deliveryType === 'restaurant' ? 
            true : // Address not needed for restaurant
            !!(state.homeDeliveryAddress.full_name && 
               state.homeDeliveryAddress.phone_number && 
               state.homeDeliveryAddress.address);

        // For home delivery cash orders, we need admin confirmation
        const needsAdminConfirmation = state.deliveryType === 'home' && 
                                     state.selectedPaymentMethod === 'Cash on Delivery' && 
                                     !state.adminConfirmed;

        // Determine if button should be disabled
        const disableButton = cartEmpty || !paymentSelected || 
                             (state.deliveryType === 'home' && !addressEntered) ||
                             needsAdminConfirmation;

        elements.checkoutButton.prop('disabled', disableButton);

        // Update button text based on verification and confirmation status
        if (state.deliveryType === 'home') {
            if (!addressEntered) {
                elements.checkoutButton.text('Enter Delivery Address');
                elements.verifyOrder.prop('disabled', true);
                elements.confirmPhone.prop('disabled', true);
            } else if (!state.paymentVerified) {
                elements.checkoutButton.text('Verify Order First');
                elements.verifyOrder.prop('disabled', false);
                elements.confirmPhone.prop('disabled', false);
            } else if (needsAdminConfirmation && !state.adminConfirmationInProgress) {
                elements.checkoutButton.text('Request Restaurant Confirmation');
            } else if (state.adminConfirmationInProgress) {
                elements.checkoutButton.text('Waiting for Restaurant Confirmation...');
            } else {
                elements.checkoutButton.text('Place Order');
                elements.verifyOrder.prop('disabled', true);
                elements.confirmPhone.prop('disabled', true);
            }
        } else {
            elements.checkoutButton.text('Place Order');
        }
    }

    // ── Event Handlers ──

    // Map Toggle - with lazy initialization
    elements.toggleMapButton.addEventListener('click', () => {
        const isMapActive = elements.mapContainer.classList.toggle('active');
        
        elements.toggleMapButton.innerHTML = isMapActive
            ? '<i class="fas fa-map"></i> Hide map'
            : '<i class="fas fa-map"></i> Show map';
            
        if (isMapActive && !state.isMapInitialized) {
            // Lazy load map when needed
            initializeMap();
        }
    });

    // Prevent manual delivery switch and alert
    elements.deliverySwitchLabels.on('click', function () {
        const wanted = $(this).data('delivery-type');
        if (state.deliveryType === wanted) return;

        if (state.deliveryType === 'restaurant') {
            alert("You must be detected as being at the restaurant for 'Eat-in' delivery.");
        } else {
            alert("Delivery type is determined by your location relative to the restaurant. You cannot manually switch to 'Eat-in' if you are not detected nearby.");
        }
        
        // Keep UI reflecting actual delivery type
        elements.deliverySwitchLabels.removeClass('active');
        $(`.delivery-switch-label[data-delivery-type="${state.deliveryType}"]`).addClass('active');
    });

    // Address Modal Handlers
    elements.openAddressModal.on('click', () => {
        // Populate modal with existing address data
        elements.modalFullName.val(state.homeDeliveryAddress.full_name || '');
        elements.modalPhoneNumber.val(state.homeDeliveryAddress.phone_number || '');
        elements.modalAddress.val(state.homeDeliveryAddress.address || '');
        elements.addressModal.addClass('active');
    });
    
    elements.closeAddressModal.on('click', () => elements.addressModal.removeClass('active'));
    elements.cancelAddress.on('click', () => elements.addressModal.removeClass('active'));
    
    elements.saveAddress.on('click', () => {
        const full = elements.modalFullName.val().trim();
        const phone = elements.modalPhoneNumber.val().trim();
        const addr = elements.modalAddress.val().trim();
        
        if (!full || !phone || !addr) {
            alert('Please fill in all fields for delivery address.');
            return;
        }
        
        state.homeDeliveryAddress = { full_name: full, phone_number: phone, address: addr };
        elements.addressModal.removeClass('active');

        // Auto-fill confirmation phone if empty
        if (elements.confirmPhone.val().trim() === '') {
            elements.confirmPhone.val(phone);
        }

        updateCheckoutButtonState();
    });

    // Payment Option Selection
    elements.paymentOptions.on('click', function () {
        // Only allow selecting active options
        if (!$(this).hasClass('active')) return;

        // Deselect others and select this one
        elements.paymentOptions.removeClass('selected');
        $(this).addClass('selected');
        state.selectedPaymentMethod = $(this).data('method');

        // Reset verification and admin confirmation for home delivery
        if (state.deliveryType === 'home') {
            state.paymentVerified = false;
            state.adminConfirmed = false;
            $('#cashDeliveryOption .order-verification-badge, #cashDeliveryOption .admin-confirmation-badge').remove();
            elements.verificationStatus.empty();
        }

        updateCheckoutButtonState();
        if ('vibrate' in navigator) navigator.vibrate(50);
    });

    // Event Delegation for Cart Item Quantity and Delete
    elements.orderDetailsList.on('click', '.increment-item', function() {
        const itemId = $(this).closest('.order-item').data('item-id');
        updateCart(itemId, +1);
    });

    elements.orderDetailsList.on('click', '.decrement-item', function() {
        const itemId = $(this).closest('.order-item').data('item-id');
        updateCart(itemId, -1);
    });

    elements.orderDetailsList.on('click', '.delete-item', function() {
        const itemId = $(this).closest('.order-item').data('item-id');
        deleteCartItem(itemId);
    });

    // Verify Order Button Handler
    elements.verifyOrder.on('click', function() {
        const phoneNumber = elements.confirmPhone.val().trim();

        // Validate phone number
        if (!phoneNumber || phoneNumber.length < 8 || !/^\d+$/.test(phoneNumber)) {
            elements.verificationStatus.html('<span style="color: #f44336;">Please enter a valid phone number (at least 8 digits).</span>');
            return;
        }

        // Show verification modal
        elements.paymentModal.css('display', 'flex');
        $('#paymentVerificationProgress').show();
        $('#paymentVerificationSuccess, #paymentVerificationFailed').hide();
        $('#continueToCheckout, #tryAgainPayment').hide();

        // Simulate verification (use setTimeout to not block UI)
        setTimeout(() => {
            const isValid = true; // Always succeed for demo
            
            $('#paymentVerificationProgress').hide();

            if (isValid) {
                $('#paymentVerificationSuccess, #continueToCheckout').show();
                state.paymentVerified = true;
                elements.verificationStatus.html('<span style="color: #4caf50;">Verification successful. Restaurant confirmation required next.</span>');
            } else {
                $('#paymentVerificationFailed, #tryAgainPayment').show();
                state.paymentVerified = false;
                elements.verificationStatus.html('<span style="color: #f44336;">Verification failed. Please try again.</span>');
            }
            
            updateCheckoutButtonState();
        }, 1000); // Reduce simulation time for better UX
    });

    // Payment Modal Handlers
    elements.closePaymentModal.on('click', function() {
        elements.paymentModal.hide();
        updateCheckoutButtonState();
    });

    elements.continueToCheckout.on('click', function() {
        elements.paymentModal.hide();
        $('#cashDeliveryOption').append('<span class="order-verification-badge"><i class="fas fa-check-circle"></i> Verified</span>');
        updateCheckoutButtonState();
    });

    elements.tryAgainPayment.on('click', function() {
        elements.paymentModal.hide();
        updateCheckoutButtonState();
    });

    // Admin Confirmation Modal Handlers
    elements.closeAdminConfirmation.on('click', function() {
        if (state.adminConfirmed) {
            elements.adminConfirmationModal.hide();
            state.adminConfirmationInProgress = false;
            updateCheckoutButtonState();
        } else {
            alert("You cannot close this window until the restaurant confirms your order or you cancel the confirmation request.");
        }
    });

    elements.tryAgainAdminConfirmation.on('click', function() {
        // Reset and try again
        state.adminConfirmationInProgress = false;
        elements.adminConfirmationModal.hide();
        
        // Small delay before requesting again for better UX
        setTimeout(() => {
            requestAdminConfirmation();
        }, 500);
    });

    // Place Order Handler
    elements.checkoutButton.on('click', function(e) {
        e.preventDefault();

        // Final validation checks
        const cart = JSON.parse(localStorage.getItem('cart') || '{}');
        
        if (Object.keys(cart).length === 0) {
            alert('Your cart is empty.');
            return;
        }
        
        if (!state.selectedPaymentMethod) {
            alert('Please select a payment method.');
            return;
        }
        
        // For home delivery with Cash on Delivery
        if (state.deliveryType === 'home' && state.selectedPaymentMethod === 'Cash on Delivery') {
            if (!state.homeDeliveryAddress.full_name || 
                !state.homeDeliveryAddress.phone_number || 
                !state.homeDeliveryAddress.address) {
                alert('Please enter your full delivery address details.');
                elements.openAddressModal.focus();
                return;
            }
            
            if (!state.paymentVerified) {
                alert('Please verify your order details first.');
                elements.verifyOrder.focus();
                return;
            }
            
            // If admin hasn't confirmed yet and not in progress already, start confirmation
            if (!state.adminConfirmed && !state.adminConfirmationInProgress) {
                requestAdminConfirmation();
                return;
            }
            
            // If admin confirmation is in progress, don't proceed
            if (state.adminConfirmationInProgress && !state.adminConfirmed) {
                alert('Please wait for the restaurant to confirm your order.');
                return;
            }
        }

        // Show loading overlay
        elements.loadingOverlay.addClass('active');

        // Build the payload
        const payload = {
            order_reference: state.orderReferenceId || generateOrderReferenceId(),
            delivery_type: state.deliveryType,
            payment_method: state.selectedPaymentMethod,
            payment_details: state.selectedPaymentMethod === 'Mobile Money' ? 
                { transaction_id: 'SIMULATED_TXN_ID' } : {},
            cart: cart,
            table_number: state.deliveryType === 'restaurant' ? state.tableNumber : null,
            delivery_details: state.deliveryType === 'home' ? {
                address: state.homeDeliveryAddress.address
            } : null,
            customer_details: state.deliveryType === 'home' ? {
                full_name: state.homeDeliveryAddress.full_name,
                phone_number: elements.confirmPhone.val().trim()
            } : null,
            admin_confirmed: state.adminConfirmed,
            admin_confirmation_timestamp: state.adminConfirmed ? new Date().toISOString() : null
        };

        console.log('Order payload:', payload);

        // Get restaurant slugs and CSRF token
        const restaurantNameSlug = elements.checkoutButton.attr('data-restaurant-name-slug');
        const hashedSlug = elements.checkoutButton.attr('data-restaurant-hashed-slug');
        const placeOrderUrl = `/restaurant/${restaurantNameSlug}/${hashedSlug}/place_order/`;
        const csrfToken = $('meta[name="csrf-token"]').attr('content');

        // Make AJAX request to place order
        $.ajax({
            url: placeOrderUrl,
            type: 'POST',
            data: JSON.stringify(payload),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': csrfToken
            },
            success: function(response) {
                elements.loadingOverlay.removeClass('active');
                if (response.success) {
                    const orderId = response.order_id;
                    const successUrl = `/restaurant/${restaurantNameSlug}/${hashedSlug}/${orderId}/order_success/`;
                    // Show success modal
                    const successMessage = `
                        <div class="order-success-modal">
                            <div class="order-success-content">
                                <i class="fas fa-check-circle success-icon"></i>
                                <h2>Order Placed Successfully!</h2>
                                <p>${state.deliveryType === 'restaurant' ? 
                                    'Please wait at your table, your order will be served soon.' : 
                                    'Your order will be delivered to the address you provided.'}</p>
                                <button id="closeSuccessModal" class="primary-button">View Order Details</button>
                            </div>
                        </div>
                    `;
                    $('body').append(successMessage);
                    $('#closeSuccessModal').on('click', function() {
                        $('.order-success-modal').remove();
                        window.location.href = successUrl;
                    });
                    // Clear cart
                    localStorage.removeItem('cart');
                } else {
                    alert('Order placement failed: ' + (response.message || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                elements.loadingOverlay.removeClass('active');
                alert('An error occurred while placing the order: ' + error);
            }
        });
    });

    // ── Initialize HTML for Admin Confirmation Modal ──
    // This would normally be in your HTML file, but added here for completeness
    if (!document.getElementById('adminConfirmationModal')) {
        const adminConfirmationHTML = `
            <div id="adminConfirmationModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Restaurant Confirmation</h2>
                        <button id="closeAdminConfirmation" class="close-modal">×</button>
                    </div>
                    <div class="modal-body">
                        <div id="adminConfirmationProgress" class="verification-progress">
                            <div class="spinner"></div>
                            <p>Requesting confirmation from the restaurant...</p>
                            <p class="countdown">Time remaining: <span id="confirmationTimeRemaining">60</span> seconds</p>
                        </div>
                        <div id="adminConfirmationStatus" class="verification-status">
                            <p>Your order reference: <strong id="orderReferenceDisplay"></strong></p>
                        </div>
                        <button id="tryAgainAdminConfirmation" class="primary-button">Try Again</button>
                    </div>
                </div>
            </div>
        `;
        
        $('body').append(adminConfirmationHTML);
        
        // Re-cache the newly added elements
        elements.adminConfirmationModal = $('#adminConfirmationModal');
        elements.adminConfirmationStatus = $('#adminConfirmationStatus');
        elements.adminConfirmationProgress = $('#adminConfirmationProgress');
        elements.closeAdminConfirmation = $('#closeAdminConfirmation');
        elements.tryAgainAdminConfirmation = $('#tryAgainAdminConfirmation');
        elements.orderReferenceDisplay = $('#orderReferenceDisplay');
        elements.confirmationTimeRemaining = $('#confirmationTimeRemaining');
    }

    // ── Initialization ──
    // Initialize on page load in a way that doesn't block rendering
    setTimeout(() => {
        // Load and render cart first (for perceived performance)
        updateOrderDetails();
        
        // Then determine location/delivery type (potentially slower operation)
        setDeliveryType();
        
        // Check for turf.js (optional dependency check)
        if (typeof turf === 'undefined') {
            console.warn("Turf.js is not loaded. Distance calculations will use fallbacks.");
        }
        
        // Add some CSS for the new admin confirmation elements
        $('<style>')
            .text(`
                .admin-confirmation-badge {
                    display: inline-block;
                    background-color: #4caf50;
                    color: white;
                    padding: 3px 8px;
                    border-radius: 15px;
                    font-size: 0.75em;
                    margin-left: 10px;
                    vertical-align: middle;
                }
                
                .countdown {
                    color: #f57c00;
                    font-weight: bold;
                    margin-top: 10px;
                }
                
                .order-success-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                }
                
                .order-success-content {
                    background-color: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                }
                
                .success-icon {
                    font-size: 60px;
                    color: #4caf50;
                    margin-bottom: 20px;
                }
            `)
            .appendTo('head');
    }, 0);
});
   </script>



</body>
</html>